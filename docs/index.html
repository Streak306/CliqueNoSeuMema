<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Clique no seu Mema</title>
<style>
  :root{
    --maxw: 1400px;
    --gap: 24px;
    --sidew: 380px;

    /* Tema escuro suave */
    --bg:        #14171c;
    --bg-grad-1: #1d222b;
    --bg-grad-2: #171b22;
    --fg:        #e7ebf0;
    --muted:     #a3adba;

    --card-bg:   #1b2029;
    --panel-bg:  #161b22;
    --border:    #2a303a;

    --pill-bg:   #181d25;
    --stage-border: #2d3441;
    --accent:    #60a5fa;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui; line-height:1.45; color:var(--fg);
    background:
      radial-gradient(900px 500px at 10% -10%, var(--bg-grad-1) 0%, transparent 40%),
      radial-gradient(900px 500px at 110% -10%, var(--bg-grad-2) 0%, transparent 35%),
      linear-gradient(180deg, #13171c 0%, var(--bg) 100%);
  }
  .wrap{max-width:var(--maxw);margin:0 auto;padding:28px}

  /* Topo */
  header{ text-align:center; position:sticky; top:0; z-index:10; padding-bottom:10px; backdrop-filter:saturate(140%) blur(4px) }
  h1{ margin:6px 0 12px 0; font-size:2.6rem; letter-spacing:.3px; }
  .stats{ display:flex;gap:12px;flex-wrap:wrap;justify-content:center }
  .pill{
    display:inline-block;padding:8px 14px;border:1px solid var(--border);
    background:var(--pill-bg); border-radius:999px; color:var(--fg)
  }
  #pts{font-size:1.6rem;font-variant-numeric:tabular-nums}

  /* simple button style (missing before) */
  .btn{
    padding:10px 14px;border:1px solid var(--border);border-radius:12px;
    background:#171c24;color:var(--fg);cursor:pointer;
    transition:filter .15s ease, transform .08s ease;
  }
  .btn:hover{ filter:brightness(1.06); }
  .btn:active{ transform:translateY(1px) }

  /* Grid principal */
  .grid{
    display:grid; grid-template-columns: var(--sidew) 1fr var(--sidew);
    gap: var(--gap); align-items:start; margin-top: 20px;
  }
  .card{ border:1px solid var(--border);border-radius:16px;padding:16px;background:var(--card-bg); }
  .card p{ color:var(--muted); }
  .muted{ color:var(--muted); }

  /* Upgrades (aba esquerda) */
  .upgrades-card{ display:flex; flex-direction:column; gap:16px; min-height: min(76vh, 820px); }
  .upgrades-title{ margin:6px 0 0; font-size:1.35rem; letter-spacing:.4px; }
  .upgrades-sub{ margin:0; font-size:.92rem; }
  .upgrade-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(72px,1fr));
    gap:12px;
  }
  .upgrade-tile{
    position:relative;
    width:100%;
    aspect-ratio:1;
    border:1px solid var(--border);
    border-radius:14px;
    background:var(--panel-bg);
    padding:0;
    overflow:visible;
    cursor:pointer;
    transition:transform .12s ease, box-shadow .15s ease, border-color .15s ease, filter .15s ease;
    display:block;
    font:inherit;
    color:inherit;
  }
  .upgrade-tile img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    border-radius:inherit;
  }
  .upgrade-tile.available:hover{ transform:translateY(-3px); box-shadow:0 12px 26px rgba(59,130,246,.28); }
  .upgrade-tile.locked{ filter:saturate(.4) brightness(.85); }
  .upgrade-tile.purchased{
    cursor:default;
    border-color:rgba(96,165,250,.55);
    box-shadow:0 12px 28px rgba(96,165,250,.24);
    filter:saturate(1.08) brightness(1.05);
  }
  .upgrade-tile:disabled{ cursor:default; }
  .upgrade-tile:focus-visible{ outline:2px solid var(--accent); outline-offset:3px; }
  .upgrade-check{
    position:absolute;
    right:6px;
    top:6px;
    background:rgba(15,23,42,.85);
    color:var(--accent);
    border-radius:999px;
    padding:2px 6px;
    font-size:12px;
    font-weight:700;
    display:none;
    align-items:center;
    justify-content:center;
  }
  .upgrade-tile.purchased .upgrade-check{ display:flex; }
  .upgrade-tile::after{
    content:attr(data-tooltip);
    position:absolute;
    left:50%;
    bottom:calc(100% + 12px);
    transform:translate(-50%, 10px);
    background:rgba(13,17,23,.95);
    color:var(--fg);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    box-shadow:0 12px 26px rgba(0,0,0,.45);
    white-space:pre-line;
    font-size:.82rem;
    min-width:180px;
    max-width:240px;
    pointer-events:none;
    opacity:0;
    transition:opacity .15s ease, transform .15s ease;
    z-index:20;
  }
  .upgrade-tile::before{
    content:'';
    position:absolute;
    left:50%;
    bottom:calc(100% + 6px);
    transform:translate(-50%, 6px);
    border:6px solid transparent;
    border-top-color:rgba(13,17,23,.95);
    opacity:0;
    transition:opacity .15s ease, transform .15s ease;
    z-index:21;
    pointer-events:none;
  }
  .upgrade-tile:hover::after,
  .upgrade-tile:focus-visible::after{ opacity:1; transform:translate(-50%, 0); }
  .upgrade-tile:hover::before,
  .upgrade-tile:focus-visible::before{ opacity:1; transform:translate(-50%, 0); }
  .upgrade-tile.buzz{ animation:buzz .15s linear 2; }

  /* make the shop card match stage height so items don't look "outside" */
  .shop-card{ min-height: min(76vh, 820px); display:flex; flex-direction:column; }

  /* Palco */
  .stage{
    display:grid; place-items:center; min-height: min(76vh, 820px);
    border:1px dashed var(--stage-border); border-radius:16px; background:var(--panel-bg);
  }
  .click-img{
    width:clamp(260px, 42vw, 420px); height:clamp(260px, 42vw, 420px); object-fit:cover;
    border:1px solid var(--border);border-radius:18px;cursor:pointer;
    box-shadow:0 10px 28px rgba(0,0,0,.38);
    transition:transform .06s ease, filter .15s ease; user-select:none;
  }
  .click-img:hover{ filter:brightness(1.06); }
  .click-img:active{ transform:translateY(1px) scale(.98); }

  /* Indicador de save */
  .save-toast{
    position:fixed; right:16px; bottom:16px;
    background:#0b1f47; color:var(--accent);
    border:1px solid #1d4ed8; border-radius:999px;
    padding:8px 12px; font-weight:700; font-size:14px;
    box-shadow:0 4px 16px rgba(0,0,0,.35);
    opacity:0; transform:translateY(8px); pointer-events:none;
    transition:opacity .6s ease, transform .6s ease;
  }
  .save-toast.show{ opacity:1; transform:translateY(0); }

  /* LOJA – tabela clicável */
  .shop-title{margin:10px 0 12px;font-weight:800; letter-spacing:.2px;}

  table.shop{width:100%; border-collapse:separate; border-spacing:0 12px; table-layout:fixed}
  .shop thead th{font-size:12px; text-align:left; opacity:.75; padding:0 10px}
  .shop tbody tr{
    background:var(--panel-bg); border:1px solid var(--border); border-radius:12px;
    transition:background .12s ease, transform .06s ease, box-shadow .12s ease, filter .12s ease;
  }
  .shop tbody td{padding:14px 12px; vertical-align:middle; overflow:hidden}
  .shop .name{font-weight:700}
  .shop .limit{opacity:.85}
  .shop .status{font-size:12px; opacity:.85; margin-top:6px}

  /* linha clicável */
  .shop tr.clickable{ cursor:pointer; }
  .shop tr.clickable:hover{ filter:brightness(1.08); box-shadow:0 8px 22px rgba(0,0,0,.28); }
  .shop tr.clickable:active{ transform:scale(.992); }
  /* limite atingido */
  .shop tr.max{ opacity:.6; cursor:not-allowed; }

  /* linha com grana suficiente */
  .shop tr.afford{
    box-shadow:0 0 0 1px rgba(16,185,129,.30), 0 6px 18px rgba(0,0,0,.25);
  }
  .shop tr.afford:hover{
    filter:brightness(1.08);
  /* owned/limit estilo grande (novo) */
  .owned-limit{ font-weight:800; font-size:1.05rem; letter-spacing:.6px; color:var(--fg); }
  .owned-limit .owned{ color:var(--fg); opacity:0.95; margin-right:6px; }
  .owned-limit .sep{ opacity:0.6; margin: 0 6px; color:var(--muted) }

  /* linha travada (não aparece até desbloquear) */
  .shop tr.locked{ display:none; }

  /* “faltam pontos” + buzz */
  .need{ font-size:12px; color:#93c5fd; opacity:.95; margin-top:4px }
  @keyframes buzz{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-2px)} 40%{transform:translateX(2px)} 60%{transform:translateX(-1px)} 80%{transform:translateX(1px)} }
  .buzz{ animation:buzz .15s linear 2 }

  @keyframes flashG{ from{box-shadow:0 0 0 2px rgba(16,185,129,.55)} to{box-shadow:0 0 0 10px rgba(16,185,129,0)} }
  .flashG{ animation:flashG .42s ease-out 1; }

  /* evita highlight azul no mobile e seleção de texto */
  .shop tbody tr{ -webkit-tap-highlight-color:transparent; user-select:none; }

  /* Responsivo */
  @media (max-width: 980px){
    :root{ --sidew: 1fr }
    .grid{ grid-template-columns: 1fr; }
    .stage{ min-height: 54vh; }
    .shop-card{ min-height: auto; }
    .upgrades-card{ min-height: auto; }
  }
</style>

<div class="wrap">
  <!-- TOPO -->
  <header>
    <h1>Memarkez</h1>
    <div class="stats">
      <span class="pill">Meminha: <b id="pts">0</b></span>
      <span class="pill">Por clique: <b id="pc">1</b></span>
      <span class="pill">MPS: <b id="mps">0</b></span>
      <button class="btn" id="deleteSave" style="max-width:220px;border-color:#3a2224;background:#24181a;color:#ef4444">Apagar save</button>
    </div>
  </header>

  <!-- GRID -->
  <main class="grid">
    <aside class="card upgrades-card">
      <h3 class="upgrades-title">Upgrades</h3>
      <p class="muted upgrades-sub">Desbloqueie melhorias comprando prédios específicos e conquiste cliques mais fortes.</p>
      <div id="upgradesGrid" class="upgrade-grid"></div>
    </aside>

    <section class="stage">
      <img id="click" class="click-img" src="imagens/variacoes-mema/mema_back.png" alt="Clique no seu Mema">
    </section>

    <aside class="card shop-card">
      <div class="shop-title">Loja</div>
      <table class="shop">
        <thead>
          <tr>
            <th>Item</th>
            <th>+MPS</th>
            <th>Qtde</th>
          </tr>
        </thead>
        <tbody id="shopBody"></tbody>
      </table>
      <p class="muted" style="margin-top:8px">Passe o mouse e clique na linha para comprar. Itens seguintes aparecem somente após comprar 1 do anterior.</p>
    </aside>
  </main>
</div>

<div id="saveToast" class="save-toast">salvo</div>

<script>
/* ===== Estado do jogo ===== */
let pts = 0, clickPow = 1, mps = 0;
let upgradesState = null;
let migratedLegacyUpgrades = false;

/* Imagens (efeito clique) */
const IMG_BACK  = 'imagens/variacoes-mema/mema_back.png';
const IMG_FRONT = 'imagens/variacoes-mema/mema_front.png';
const FRONT_TIME_MS = 400;
let faceTimer = null;

/* Helpers */
const el=(id)=>document.getElementById(id);
const fmt = (n)=> Math.floor(n); // evita exibir mais pontos do que você tem

/* formatação curta legível (K/M/B/T) */
function fmtShort(n){
  const abs = Math.abs(n);
  if(abs >= 1e12) return (n/1e12).toFixed(3)+'T';
  if(abs >= 1e9)  return (n/1e9 ).toFixed(3)+'B';
  if(abs >= 1e6)  return (n/1e6 ).toFixed(2)+'M';
  if(abs >= 1e3)  return (n/1e3 ).toFixed(2)+'K';
  return Math.floor(n).toString();
}

/* SAVE/LOAD */
let shopState = null; // definido após catálogo
function save(showToast=false){
  localStorage.setItem('mcw', JSON.stringify({pts,clickPow,mps, shopState, upgradesState}));
  if(showToast) flashSave();
}
function load(){ try{
  migratedLegacyUpgrades = false;
  const d = JSON.parse(localStorage.getItem('mcw')||'{}');
  pts=d.pts??0; clickPow=d.clickPow??1; mps=d.mps??0;
  if(d.shopState) shopState = {...makeInitialShopState(), ...d.shopState};
  if(d.upgradesState){
    const base = makeInitialUpgradeState();
    upgradesState = {...base};
    Object.keys(d.upgradesState).forEach(id=>{
      if(!base[id]) return;
      const prev = d.upgradesState[id] || {};
      const purchased = !!(prev.purchased ?? prev.unlocked);
      upgradesState[id] = {...base[id], purchased, unlocked:purchased};
      if(prev.unlocked !== undefined && prev.purchased === undefined){
        migratedLegacyUpgrades = true;
      }
    });
  }
} catch(e){} }

/* HUD (topo) */
function renderHUD(){
  el('pts').textContent = fmtShort(pts);
  el('pc').textContent = Math.floor(clickPow);
  el('mps').textContent = mps.toFixed(2);
  // não re-renderiza a loja aqui
}

/* feedback imagem */
function showFront(){
  const img = el('click');
  img.src = IMG_FRONT;
  if (faceTimer) clearTimeout(faceTimer);
  faceTimer = setTimeout(()=>{ img.src = IMG_BACK; }, FRONT_TIME_MS);
}

/* reset */
function resetState(){
  pts=0; clickPow=1; mps=0;
  shopState = makeInitialShopState();
  upgradesState = makeInitialUpgradeState();
}
function deleteSave(){
  const ok = confirm('Apagar seu save? Esta ação não pode ser desfeita.');
  if(!ok) return;
  localStorage.removeItem('mcw');
  resetState(); renderShop(); renderUpgrades(); recalculateProduction(); renderHUD();
}

/* loop de meminhas automáticos (MPS) */
function loop(){
  let last=performance.now();
  function tick(){
    const now=performance.now(), dt=(now-last)/1000; last=now;
    pts += mps*dt;
    renderHUD();           // atualiza só o topo
    updateAffordability(); // pinta se dá pra comprar, sem recriar DOM
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

/* auto-save + toast */
let saveTimer = null;
function startAutoSave(){
  if(saveTimer) clearInterval(saveTimer);
  saveTimer = setInterval(()=> save(true), 5000);
}
let toastTimer=null;
function flashSave(){
  const t = el('saveToast');
  t.textContent = 'salvo';
  t.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.classList.remove('show'), 1400);
}

/* preload imagens */
(new Image()).src = IMG_BACK;
(new Image()).src = IMG_FRONT;

/* ===== Loja =====
   Agora usamos as fórmulas exponenciais:
   precoProximo(base, escala, q) = ceil(base * escala^q)
*/

/* Parâmetros sugeridos (base, escala, mps/base) */
const SHOP = [
  {id:'dedo',       name:'Dedo',       base:15,          r:1.07, p:0.10, limit:50},
  {id:'roupa',      name:'Roupa',      base:100,         r:1.10, p:1.00,  limit:20},
  {id:'agua',       name:'Água',       base:1100,        r:1.12, p:8.00,  limit:20},
  {id:'plantacao',  name:'Plantação',  base:12000,       r:1.13, p:47.0,  limit:12},
  {id:'alojamento', name:'Alojamento', base:130000,      r:1.14, p:260.0, limit:8},
  {id:'casa',       name:'Casa',       base:1400000,     r:1.15, p:1400.0,limit:5},
  {id:'xbox',       name:'Xbox',       base:20000000,    r:1.16, p:7800.0, limit:3},
  {id:'computador', name:'Computador', base:330000000,   r:1.17, p:44000.0,limit:3},
  {id:'microfone',  name:'Microfone',  base:5100000000,  r:1.18, p:260000.0,limit:2},
  {id:'namorada',   name:'Namorada',   base:75000000000, r:1.20, p:1600000.0,limit:1}
];

const SHOP_LOOKUP = SHOP.reduce((acc, item)=>{ acc[item.id] = item; return acc; }, {});

const UPGRADE_DATA = [
  {
    id:'up-roupa-t1',
    name:'Tênis Impressionante',
    effect:'+10% MPS gerado por Roupa',
    cost:1000,
    img:'imagens/melhorias-futuras/up-roupa-t1.png',
    requirement:{type:'building', building:'roupa', count:1},
    requirementText:'Compre 1 Roupa',
    bonus:{type:'building', target:'roupa', amount:0.10}
  },
  {
    id:'up-agua-t1',
    name:'Água Salgada',
    effect:'+10% MPS gerado por Água',
    cost:12000,
    img:'imagens/melhorias-futuras/up-agua-t1.png',
    requirement:{type:'building', building:'agua', count:1},
    requirementText:'Compre 1 Água',
    bonus:{type:'building', target:'agua', amount:0.10}
  },
  {
    id:'up-plantacao-t1',
    name:'Fertilizante',
    effect:'+12% MPS gerado por Plantação',
    cost:180000,
    img:'imagens/melhorias-futuras/up-plantacao-t1.png',
    requirement:{type:'building', building:'plantacao', count:1},
    requirementText:'Compre 1 Plantação',
    bonus:{type:'building', target:'plantacao', amount:0.12}
  },
  {
    id:'up-alojamento-t1',
    name:'Cerca',
    effect:'+12% MPS gerado por Alojamento',
    cost:2000000,
    img:'imagens/melhorias-futuras/up-alojamento-t1.png',
    requirement:{type:'building', building:'alojamento', count:1},
    requirementText:'Compre 1 Alojamento',
    bonus:{type:'building', target:'alojamento', amount:0.12}
  },
  {
    id:'up-casa-t1',
    name:'Porta',
    effect:'+15% MPS gerado por Casa',
    cost:30000000,
    img:'imagens/melhorias-futuras/up-casa-t1.png',
    requirement:{type:'building', building:'casa', count:1},
    requirementText:'Compre 1 Casa',
    bonus:{type:'building', target:'casa', amount:0.15}
  },
  {
    id:'up-xbox-t1',
    name:'Controle360',
    effect:'+15% MPS gerado por Xbox',
    cost:450000000,
    img:'imagens/melhorias-futuras/up-xbox-t1.png',
    requirement:{type:'building', building:'xbox', count:1},
    requirementText:'Compre 1 Xbox',
    bonus:{type:'building', target:'xbox', amount:0.15}
  },
  {
    id:'up-computador-t1',
    name:'Ryzen',
    effect:'+18% MPS gerado por Computador',
    cost:6000000000,
    img:'imagens/melhorias-futuras/up-computador-t1.png',
    requirement:{type:'building', building:'computador', count:1},
    requirementText:'Compre 1 Computador',
    bonus:{type:'building', target:'computador', amount:0.18}
  },
  {
    id:'up-microfone-t1',
    name:'Rap de Anime',
    effect:'+20% MPS gerado por Microfone',
    cost:90000000000,
    img:'imagens/melhorias-futuras/up-microfone-t1.png',
    requirement:{type:'building', building:'microfone', count:1},
    requirementText:'Compre 1 Microfone',
    bonus:{type:'building', target:'microfone', amount:0.20}
  },
  {
    id:'up-dedo-t1',
    name:'Mão aprimorada',
    effect:'Cada Dedo gera +1 clique extra',
    cost:5000,
    img:'imagens/melhorias-futuras/up-dedo-t1.png',
    requirement:{type:'building', building:'dedo', count:10},
    requirementText:'Tenha 10 Dedos',
    bonus:{type:'finger', perDedo:1}
  },
  {
    id:'up-dedo-t2',
    name:'Mão de Graphite',
    effect:'Cada Dedo gera +1 clique extra (acumula)',
    cost:250000,
    img:'imagens/melhorias-futuras/up-dedo-t2.png',
    requirement:{type:'building', building:'dedo', count:25},
    requirementText:'Tenha 25 Dedos e o upgrade anterior',
    requires:['up-dedo-t1'],
    bonus:{type:'finger', perDedo:1}
  },
  {
    id:'up-dedo-t3',
    name:'Mão de Slate',
    effect:'Cada Dedo gera +1 clique extra (acumula)',
    cost:10000000,
    img:'imagens/melhorias-futuras/up-dedo-t3.png',
    requirement:{type:'building', building:'dedo', count:40},
    requirementText:'Tenha 40 Dedos e o upgrade anterior',
    requires:['up-dedo-t2'],
    bonus:{type:'finger', perDedo:1}
  }
];

const UPGRADE_MAP = UPGRADE_DATA.reduce((acc, up)=>{ acc[up.id] = up; return acc; }, {});
const upgradeElements = new Map();

function makeInitialShopState(){
  const s={};
  SHOP.forEach(it=> s[it.id] = {owned:0});
  return s;
}
if(!shopState) shopState = makeInitialShopState();

function makeInitialUpgradeState(){
  const s={};
  UPGRADE_DATA.forEach(up=> s[up.id] = {purchased:false, unlocked:false});
  return s;
}
if(!upgradesState) upgradesState = makeInitialUpgradeState();

/* Fórmulas utilitárias */
function precoProximo(base, escala, qPossuidas){
  return Math.ceil(base * Math.pow(escala, qPossuidas));
}
/* Render da loja — atualiza visibilidade e cores com base em pts e desbloqueio */
function renderShop(){
  const body = document.getElementById('shopBody');
  if(!body) return;
  body.innerHTML='';

  SHOP.forEach((it, idx)=>{
    const st = shopState[it.id];
    const atLimit = st.owned >= it.limit;

    // desbloqueio: item só aparece quando o anterior tiver ao menos 1 comprado
    const locked = idx > 0 && (shopState[SHOP[idx-1].id].owned < 1);

    if(locked){
      // mantém a progressão da loja escondendo completamente itens futuros
      return;
    }

    const tr = document.createElement('tr');
    tr.dataset.buy = it.id;

    tr.className = atLimit ? 'max' : 'clickable';

    // determinar preço da próxima unidade
    const priceSingle = precoProximo(it.base, it.r, st.owned);

    // determinar se pode comprar agora (custo alcançável e não no limite)
    const canAffordSingle = (!atLimit) && (pts >= priceSingle);

    // Se o item estiver desbloqueado mas você ainda não possui NENHUM (owned === 0),
    // mostramos "?????" no lugar do nome para criar surpresa antes da primeira compra.
    const displayName = (!locked && st.owned === 0) ? '?????' : it.name;

    tr.innerHTML = `
      <td class="name">
        <div>${displayName}</div>
        <div class="cost ${canAffordSingle ? 'can' : 'cant'}">Custo: ${fmtShort(priceSingle)}</div>
        <div class="status">${atLimit ? 'MAX' : ''}</div>
      </td>
      <td>+${it.p.toFixed(2)}</td>
      <td class="owned-limit"><span class="owned">${st.owned}</span><span class="sep">/</span><span class="limit-num">${it.limit}</span></td>
    `;

    // aplica a classe visual de "pode comprar" se o preço couber
    tr.classList.toggle('afford', canAffordSingle);

    if(!locked && !atLimit){
      // clique na linha inteira --> tenta comprar 1 unidade
      tr.addEventListener('click', ()=> {
        tryBuy(it.id);
      });
      // acessibilidade básica (Enter/Space)
      tr.setAttribute('tabindex', '0');
      tr.setAttribute('role','button');
      tr.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          tryBuy(it.id);
        }
      });
    }

    body.appendChild(tr);
  });
}

function isUpgradePurchased(id){
  const st = upgradesState?.[id];
  if(!st) return false;
  if(typeof st.purchased === 'boolean') return st.purchased;
  return !!st.unlocked;
}

function setUpgradePurchased(id, value=true){
  if(!upgradesState[id]) upgradesState[id] = {purchased:false, unlocked:false};
  upgradesState[id].purchased = value;
  upgradesState[id].unlocked = value;
}

function canShowUpgrade(up){
  if(isUpgradePurchased(up.id)) return true;
  if(up.requires && up.requires.some(reqId=> !isUpgradePurchased(reqId))) return false;
  const req = up.requirement;
  if(req?.type === 'building'){
    const owned = shopState[req.building]?.owned ?? 0;
    if(owned < req.count) return false;
  }
  return true;
}

function getUpgradeRequirementLines(up){
  const lines = [];
  if(up.requirementText) lines.push(up.requirementText);
  if(up.requirement?.type === 'building'){
    const owned = shopState[up.requirement.building]?.owned ?? 0;
    const name = SHOP_LOOKUP[up.requirement.building]?.name ?? up.requirement.building;
    lines.push(`${name}: ${Math.min(owned, up.requirement.count)}/${up.requirement.count}`);
  }
  if(up.requires && up.requires.length){
    up.requires.forEach(reqId=>{
      const name = UPGRADE_MAP[reqId]?.name ?? reqId;
      lines.push(`${name}: ${isUpgradePurchased(reqId) ? 'comprado' : 'pendente'}`);
    });
  }
  return lines;
}

function buildUpgradeTooltip(up, purchased, affordable){
  const cost = up.cost ?? 0;
  const lines = [up.name, `Custo: ${fmtShort(cost)}`];
  if(up.effect){
    lines.push(`Efeito: ${up.effect}`);
  }
  if(purchased){
    lines.push('Já comprado');
  } else {
    const miss = Math.max(0, Math.ceil(cost - pts));
    if(miss > 0){
      lines.push(`Faltam ${fmtShort(miss)} pts`);
    } else if(affordable){
      lines.push('Pronto para comprar');
    }
  }
  return lines.join('\n');
}

function updateUpgradeElement(el, up){
  const cost = up.cost ?? 0;
  const purchased = isUpgradePurchased(up.id);
  const affordable = pts >= cost;
  el.classList.toggle('purchased', purchased);
  el.classList.toggle('available', !purchased && affordable);
  el.classList.toggle('locked', !purchased && !affordable);
  el.disabled = purchased;
  el.dataset.tooltip = buildUpgradeTooltip(up, purchased, affordable);
}

function updateUpgradeAffordability(){
  upgradeElements.forEach((el, id)=>{
    const up = UPGRADE_MAP[id];
    if(up) updateUpgradeElement(el, up);
  });
}

function getUpgradeElement(id){
  if(upgradeElements.has(id)) return upgradeElements.get(id);
  const el = document.querySelector(`[data-upgrade="${id}"]`);
  if(el) upgradeElements.set(id, el);
  return el;
}

function tryBuyUpgrade(id){
  const up = UPGRADE_MAP[id];
  if(!up) return;
  if(isUpgradePurchased(id)) return;
  if(!canShowUpgrade(up)) return;
  const cost = up.cost ?? 0;
  if(pts < cost){
    const el = getUpgradeElement(id);
    if(el){
      el.classList.add('buzz');
      setTimeout(()=> el.classList.remove('buzz'), 320);
    }
    return;
  }

  pts -= cost;
  setUpgradePurchased(id, true);
  recalculateProduction();
  renderUpgrades();
  renderHUD();
  save(true);
}

function getBuildingMultiplier(buildingId){
  let bonus = 0;
  UPGRADE_DATA.forEach(up=>{
    if(!isUpgradePurchased(up.id)) return;
    if(up.bonus?.type === 'building' && up.bonus.target === buildingId){
      bonus += up.bonus.amount;
    }
  });
  return 1 + bonus;
}

function getFingerExtraPerDedo(){
  let extra = 0;
  UPGRADE_DATA.forEach(up=>{
    if(!isUpgradePurchased(up.id)) return;
    if(up.bonus?.type === 'finger'){
      extra += up.bonus.perDedo ?? 0;
    }
  });
  return extra;
}

function recalculateProduction(){
  let total = 0;
  SHOP.forEach(it=>{
    const owned = shopState[it.id]?.owned ?? 0;
    if(!owned) return;
    const multiplier = getBuildingMultiplier(it.id);
    total += owned * it.p * multiplier;
  });
  mps = total;
  const dedos = shopState.dedo?.owned ?? 0;
  const perDedo = getFingerExtraPerDedo();
  clickPow = 1 + (dedos * perDedo);
}

function renderUpgrades(){
  const grid = document.getElementById('upgradesGrid');
  if(!grid) return;
  grid.innerHTML = '';
  upgradeElements.clear();

  const fragment = document.createDocumentFragment();

  UPGRADE_DATA.forEach(up=>{
    const purchased = isUpgradePurchased(up.id);
    const visible = purchased || canShowUpgrade(up);
    if(!visible) return;

    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'upgrade-tile';
    item.dataset.upgrade = up.id;
    item.setAttribute('aria-label', up.name);

    const img = document.createElement('img');
    img.className = 'upgrade-img';
    img.src = up.img;
    img.alt = up.name;
    item.appendChild(img);

    const check = document.createElement('span');
    check.className = 'upgrade-check';
    check.textContent = '✔';
    item.appendChild(check);

    updateUpgradeElement(item, up);

    if(!purchased){
      item.addEventListener('click', ()=> tryBuyUpgrade(up.id));
    }

    fragment.appendChild(item);
    upgradeElements.set(up.id, item);
  });

  grid.appendChild(fragment);
  updateUpgradeAffordability();
}

/* Atualiza apenas as classes de acessibilidade (can/cant) sem re-renderizar linhas */
function updateAffordability(){
  SHOP.forEach(it=>{
    const st   = shopState[it.id];
    const row  = document.querySelector(`tr[data-buy="${it.id}"]`);
    if(!row) return;

    const priceSingle = precoProximo(it.base, it.r, st.owned);
    const can = (st.owned < it.limit) && (pts >= priceSingle);

    const costEl = row.querySelector('.cost');
    if(costEl){
      costEl.classList.toggle('can',  pts >= priceSingle && st.owned < it.limit);
      costEl.classList.toggle('cant', !(pts >= priceSingle && st.owned < it.limit));
    }
    row.classList.toggle('afford', can);
  });

  updateUpgradeAffordability();
}

/* Tenta comprar item ao clicar na linha */
function tryBuy(id){
  const it = SHOP.find(x=>x.id===id); if(!it) return;
  const st = shopState[id];
  const remainingLimit = it.limit - st.owned;
  if(remainingLimit <= 0) return;

  const priceSingle = precoProximo(it.base, it.r, st.owned);
  // encontrar a linha atual no DOM (pode ter sido re-renderizada)
  const row = document.querySelector(`tr[data-buy="${id}"]`);

  if(pts < priceSingle){
    if(row){
      // feedback: buzz + "faltam X pts"
      row.classList.add('buzz');
      const miss = Math.ceil(priceSingle - pts);
      const s = row.querySelector('.status');
      if(s){
        s.innerHTML = `<span class="need">Faltam ${miss} pts</span>`;
        setTimeout(()=>{ if(s.querySelector('.need')) s.textContent = ''; }, 900);
      }
      setTimeout(()=> row.classList.remove('buzz'), 320);
    }
    return;
  }

  // compra: subtrai custo e atualiza owned
  pts -= priceSingle;
  st.owned += 1;

  recalculateProduction();

  // If reached limit, visually mark
  if(st.owned >= it.limit){
    if(row){
      row.classList.remove('clickable'); row.classList.add('max');
      const s = row.querySelector('.status'); if(s) s.textContent = 'MAX';
    }
  }

  // Ao comprar, possivelmente desbloqueia o próximo item — re-render da loja
  renderShop();
  renderUpgrades();
  renderHUD();
  save(true);

  // aplica flash na nova linha renderizada
  const newRow = document.querySelector(`tr[data-buy="${id}"]`);
  if(newRow) {
    newRow.classList.add('flashG');
    setTimeout(()=> newRow.classList.remove('flashG'), 450);
  }
}

/* init */
load();
recalculateProduction();
renderShop();
renderUpgrades();
renderHUD();
if(migratedLegacyUpgrades) save();
loop();
startAutoSave();

/* clique na imagem = ganhar pontos */
function getClickGain(){
  return Math.max(1, Math.floor(clickPow));
}
el('click').onclick=()=>{ pts+=getClickGain(); renderHUD(); save(); showFront(); };

/* ações */
el('deleteSave').onclick=deleteSave;
</script>
