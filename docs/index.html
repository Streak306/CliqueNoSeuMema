<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Clique no seu Mema</title>
<style>
  :root{
    --maxw: 1400px;
    --gap: 24px;
    --sidew: 380px;

    /* Tema escuro suave */
    --bg:        #14171c;
    --bg-grad-1: #1d222b;
    --bg-grad-2: #171b22;
    --fg:        #e7ebf0;
    --muted:     #a3adba;

    --card-bg:   #1b2029;
    --panel-bg:  #161b22;
    --border:    #2a303a;

    --pill-bg:   #181d25;
    --stage-border: #2d3441;
    --accent:    #60a5fa;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui; line-height:1.45; color:var(--fg);
    background:
      radial-gradient(900px 500px at 10% -10%, var(--bg-grad-1) 0%, transparent 40%),
      radial-gradient(900px 500px at 110% -10%, var(--bg-grad-2) 0%, transparent 35%),
      linear-gradient(180deg, #13171c 0%, var(--bg) 100%);
  }
  .wrap{max-width:var(--maxw);margin:0 auto;padding:28px}

  /* Topo */
  header{ text-align:center; position:sticky; top:0; z-index:10; padding-bottom:10px; backdrop-filter:saturate(140%) blur(4px) }
  h1{ margin:6px 0 12px 0; font-size:2.6rem; letter-spacing:.3px; }
  .stats{ display:flex;gap:12px;flex-wrap:wrap;justify-content:center }
  .pill{
    display:inline-block;padding:8px 14px;border:1px solid var(--border);
    background:var(--pill-bg); border-radius:999px; color:var(--fg)
  }
  #pts{font-size:1.6rem;font-variant-numeric:tabular-nums}

  /* simple button style (missing before) */
  .btn{
    padding:10px 14px;border:1px solid var(--border);border-radius:12px;
    background:#171c24;color:var(--fg);cursor:pointer;
    transition:filter .15s ease, transform .08s ease;
    font-weight:600;
  }
  .btn:hover{ filter:brightness(1.06); }
  .btn:active{ transform:translateY(1px) }

  /* Grid principal */
  .grid{
    display:grid; grid-template-columns: var(--sidew) 1fr var(--sidew);
    gap: var(--gap); align-items:start; margin-top: 20px;
  }
  .card{ border:1px solid var(--border);border-radius:16px;padding:16px;background:var(--card-bg); }
  .card p{ color:var(--muted); }
  .muted{ color:var(--muted); }

  /* Upgrades (aba esquerda) */
  .upgrades-card{ display:flex; flex-direction:column; gap:16px; min-height: min(76vh, 820px); }
  .upgrades-title{ margin:6px 0 0; font-size:1.35rem; letter-spacing:.4px; }
  .upgrades-sub{ margin:0; font-size:.92rem; }
  .upgrade-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(72px,1fr));
    gap:12px;
  }
  .tooltip-host{ position:relative; }

  .upgrade-tile{
    position:relative;
    width:100%;
    aspect-ratio:1;
    border:1px solid var(--border);
    border-radius:14px;
    background:var(--panel-bg);
    padding:0;
    overflow:visible;
    cursor:pointer;
    transition:transform .12s ease, box-shadow .15s ease, border-color .15s ease, filter .15s ease;
    display:block;
    font:inherit;
    color:inherit;
  }
  .upgrade-tile img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    border-radius:inherit;
  }
  .upgrade-tile.available{
    border-color:rgba(96,165,250,.65);
    box-shadow:0 10px 26px rgba(96,165,250,.26);
    background:linear-gradient(180deg, rgba(96,165,250,.22) 0%, rgba(23,27,34,1) 60%);
    filter:saturate(1.05) brightness(1.02);
  }
  .upgrade-tile.available:hover{ transform:translateY(-3px); box-shadow:0 14px 30px rgba(59,130,246,.32); }
  .upgrade-tile.locked{
    filter:grayscale(.85) brightness(.72);
    border-color:rgba(32,38,48,.9);
    background:#12161d;
    opacity:.8;
  }
  .upgrade-tile.purchased{
    cursor:default;
    border-color:rgba(96,165,250,.55);
    box-shadow:0 12px 28px rgba(96,165,250,.24);
    filter:saturate(1.08) brightness(1.05);
  }
  .upgrade-tile:disabled{ cursor:default; }
  .upgrade-tile:focus-visible{ outline:2px solid var(--accent); outline-offset:3px; }
  .upgrade-check{
    position:absolute;
    right:6px;
    top:6px;
    background:rgba(15,23,42,.85);
    color:var(--accent);
    border-radius:999px;
    padding:2px 6px;
    font-size:12px;
    font-weight:700;
    display:none;
    align-items:center;
    justify-content:center;
  }
  .upgrade-tile.purchased .upgrade-check{ display:flex; }
  .upgrade-info{
    position:absolute;
    left:8px;
    right:8px;
    bottom:8px;
    background:rgba(13,17,23,.88);
    border:1px solid rgba(42,48,60,.9);
    border-radius:12px;
    padding:8px 10px;
    display:flex;
    flex-direction:column;
    gap:6px;
    pointer-events:none;
    box-shadow:0 10px 20px rgba(0,0,0,.45);
    opacity:0;
    transform:translateY(6px);
    transition:opacity .18s ease, transform .18s ease;
  }
  .upgrade-tile:hover .upgrade-info,
  .upgrade-tile:focus-visible .upgrade-info{
    opacity:1;
    transform:translateY(0);
  }
  .upgrade-info strong{
    font-size:.82rem;
    line-height:1.2;
  }
  .upgrade-info .upgrade-details{
    font-size:.72rem;
    color:var(--muted);
    line-height:1.35;
  }
  .upgrade-info .upgrade-status{
    font-size:.7rem;
    color:var(--muted);
    text-align:right;
  }
  .tooltip-card{
    position:fixed;
    pointer-events:none;
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:200px;
    max-width:min(260px, 92vw);
    padding:14px 16px;
    background:rgba(13,17,23,.96);
    border:1px solid rgba(96,165,250,.35);
    border-radius:14px;
    box-shadow:0 16px 34px rgba(0,0,0,.5);
    color:var(--fg);
    opacity:0;
    visibility:hidden;
    transform:translateY(8px);
    transition:opacity .16s ease, transform .16s ease;
    z-index:60;
  }
  .tooltip-card.visible{
    opacity:1;
    visibility:visible;
    transform:translateY(0);
  }
  .tooltip-card .tooltip-name{
    font-weight:700;
    font-size:.92rem;
    line-height:1.25;
  }
  .tooltip-card .tooltip-effect{
    font-size:.8rem;
    color:var(--muted);
    line-height:1.4;
  }
  .tooltip-card .tooltip-cost{
    font-size:.78rem;
    border-top:1px solid rgba(96,165,250,.25);
    padding-top:8px;
    margin-top:4px;
    letter-spacing:.15px;
  }
  .upgrade-tile.buzz{ animation:buzz .15s linear 2; }

  /* make the shop card match stage height so items don't look "outside" */
  .shop-card{ min-height: min(76vh, 820px); display:flex; flex-direction:column; }

  /* Modal de configurações */
  .settings-btn{ display:flex; align-items:center; gap:8px; }
  .settings-btn svg{ width:18px; height:18px; }

  .modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(10,12,18,.78);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:40;
  }
  .modal-overlay.open{ display:flex; }
  .modal-card{
    width:min(760px, 92vw);
    max-height:88vh;
    background:var(--card-bg);
    border:1px solid var(--border);
    border-radius:20px;
    box-shadow:0 24px 60px rgba(0,0,0,.45);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .modal-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:20px 24px 12px 24px;
    border-bottom:1px solid var(--border);
  }
  .modal-header h2{ margin:0; font-size:1.5rem; }
  .modal-close{
    background:none;
    border:none;
    color:var(--muted);
    cursor:pointer;
    font-size:1.6rem;
    line-height:1;
    padding:4px 8px;
  }
  .modal-tabs{
    display:flex;
    gap:8px;
    padding:14px 24px;
    border-bottom:1px solid var(--border);
  }
  .modal-tab{
    border:none;
    border-radius:999px;
    padding:8px 18px;
    background:var(--pill-bg);
    color:var(--muted);
    cursor:pointer;
    font-weight:600;
    transition:filter .15s ease, background .15s ease, color .15s ease;
  }
  .modal-tab.active{
    background:rgba(96,165,250,.16);
    color:var(--fg);
    box-shadow:0 0 0 1px rgba(96,165,250,.4);
  }
  .modal-content{
    padding:24px;
    overflow:auto;
    flex:1;
  }
  .modal-panel{ display:none; }
  .modal-panel.active{ display:block; }

  .stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
    gap:16px;
    margin-bottom:22px;
  }
  .stat-card{
    background:var(--panel-bg);
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px 16px;
  }
  .stat-card span{ display:block; font-size:.85rem; color:var(--muted); margin-bottom:6px; }
  .stat-card strong{ font-size:1.1rem; letter-spacing:.3px; }

  .collection-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px;
  }
  .collection-count{ color:var(--muted); font-weight:600; }

  .collection-section{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
  }
  .collection-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(88px,1fr));
    gap:14px;
    flex:1 1 300px;
  }
  .collection-slot{
    position:relative;
    aspect-ratio:1;
    border:1px dashed var(--border);
    border-radius:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:var(--panel-bg);
    overflow:hidden;
  }
  .collection-slot img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .slot-placeholder{
    font-size:2rem;
    color:var(--muted);
    opacity:.65;
  }
  .collection-slot.owned{ border-style:solid; border-color:rgba(96,165,250,.55); box-shadow:0 10px 26px rgba(96,165,250,.24); }
  .collection-slot.selected{
    border-style:solid;
    border-color:rgba(96,165,250,.75);
    box-shadow:0 0 0 2px rgba(96,165,250,.35), 0 14px 32px rgba(96,165,250,.30);
  }
  .collection-slot.owned .slot-placeholder{ display:none; }
  .collection-slot .slot-name{
    position:absolute;
    left:8px;
    right:8px;
    bottom:8px;
    background:rgba(13,17,23,.78);
    border-radius:12px;
    padding:4px 6px;
    font-size:.7rem;
    text-align:center;
    color:var(--fg);
  }

  .collection-details{
    flex:1 1 240px;
    min-width:240px;
    border:1px solid var(--border);
    border-radius:16px;
    background:var(--panel-bg);
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .collection-details h4{
    margin:0;
    font-size:1.1rem;
  }
  .collection-details p{
    margin:0;
    color:var(--muted);
    font-size:.9rem;
    line-height:1.4;
  }
  .collection-detail-meta{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .collection-detail-meta .label{
    display:block;
    font-size:.75rem;
    letter-spacing:.4px;
    text-transform:uppercase;
    color:var(--muted);
    margin-bottom:4px;
  }
  .collection-detail-meta strong{
    font-size:.95rem;
  }
  .collection-detail-meta ul{
    margin:0;
    padding-left:18px;
    color:var(--muted);
    font-size:.9rem;
    line-height:1.4;
  }
  .collection-detail-meta ul li{ margin-bottom:4px; }
  .collection-detail-meta ul li:last-child{ margin-bottom:0; }
  .collection-detail-ownership{
    margin-top:auto;
    font-size:.8rem;
    color:var(--muted);
  }
  @media (max-width:720px){
    .collection-details{ flex-basis:100%; }
  }

  .achievements-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:12px;
  }
  .achievements-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(220px,1fr));
    gap:14px;
  }
  .achievement-card{
    background:var(--panel-bg);
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px 16px;
    min-height:96px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    gap:6px;
    position:relative;
  }
  .achievement-card::before{
    content:'';
    position:absolute;
    inset:0;
    border-radius:inherit;
    pointer-events:none;
    transition:opacity .2s ease;
    opacity:0;
    box-shadow:0 12px 28px rgba(96,165,250,.18);
  }
  .achievement-card.unlocked::before{ opacity:1; }
  .achievement-card.locked{
    opacity:.68;
    filter:grayscale(.78);
  }
  .achievement-name{
    margin:0;
    font-weight:700;
    font-size:1rem;
  }
  .achievement-desc{
    margin:0;
    color:var(--muted);
    font-size:.9rem;
  }

  .achievement-toast{
    position:fixed;
    left:50%;
    bottom:18px;
    transform:translate(-50%, 22px);
    background:rgba(15,23,42,.92);
    color:var(--fg);
    border:1px solid rgba(96,165,250,.55);
    border-radius:999px;
    padding:10px 20px;
    font-weight:700;
    font-size:.95rem;
    box-shadow:0 18px 38px rgba(15,23,42,.45);
    opacity:0;
    pointer-events:none;
    transition:opacity .4s ease, transform .4s ease;
    z-index:35;
    text-align:center;
  }
  .achievement-toast.show{
    opacity:1;
    transform:translate(-50%, 0);
  }

  /* Palco */
  .stage{
    display:grid; place-items:center; min-height: min(76vh, 820px);
    border:1px dashed var(--stage-border); border-radius:16px; background:var(--panel-bg);
  }
  .click-img{
    width:clamp(260px, 42vw, 420px); height:clamp(260px, 42vw, 420px); object-fit:cover;
    border:1px solid var(--border);border-radius:18px;cursor:pointer;
    box-shadow:0 10px 28px rgba(0,0,0,.38);
    transition:transform .06s ease, filter .15s ease; user-select:none;
  }
  .click-img:hover{ filter:brightness(1.06); }
  .click-img:active{ transform:translateY(1px) scale(.98); }

  /* Indicador de save */
  .save-toast{
    position:fixed; right:16px; bottom:16px;
    background:#0b1f47; color:var(--accent);
    border:1px solid #1d4ed8; border-radius:999px;
    padding:8px 12px; font-weight:700; font-size:14px;
    box-shadow:0 4px 16px rgba(0,0,0,.35);
    opacity:0; transform:translateY(8px); pointer-events:none;
    transition:opacity .6s ease, transform .6s ease;
  }
  .save-toast.show{ opacity:1; transform:translateY(0); }

  /* LOJA – tabela clicável */
  .shop-title{margin:10px 0 12px;font-weight:800; letter-spacing:.2px;}

  table.shop{width:100%; border-collapse:separate; border-spacing:0 12px; table-layout:fixed}
  .shop thead th{font-size:12px; text-align:left; opacity:.75; padding:0 10px}
  .shop tbody tr{
    background:var(--panel-bg); border:1px solid var(--border); border-radius:12px;
    transition:background .12s ease, transform .06s ease, box-shadow .12s ease, filter .12s ease;
  }
  .shop tbody td{padding:14px 12px; vertical-align:middle; overflow:hidden}
  .shop .name{font-weight:700}
  .shop .limit{opacity:.85}
  .shop .status{font-size:12px; opacity:.85; margin-top:6px}

  /* linha clicável */
  .shop tr.clickable{ cursor:pointer; }
  .shop tr.clickable:hover{ filter:brightness(1.08); box-shadow:0 8px 22px rgba(0,0,0,.28); }
  .shop tr.clickable:active{ transform:scale(.992); }
  /* limite atingido */
  .shop tr.max{ opacity:.6; cursor:not-allowed; }

  /* linha com grana suficiente */
  .shop tr.afford{
    box-shadow:0 0 0 1px rgba(16,185,129,.30), 0 6px 18px rgba(0,0,0,.25);
  }
  .shop tr.afford:hover{
    filter:brightness(1.08);
  }
  /* owned/limit estilo grande (novo) */
  .owned-limit{ font-weight:800; font-size:1.05rem; letter-spacing:.6px; color:var(--fg); }
  .owned-limit .owned{ color:var(--fg); opacity:0.95; margin-right:6px; }
  .owned-limit .sep{ opacity:0.6; margin: 0 6px; color:var(--muted) }

  /* linha travada (não aparece até desbloquear) */
  .shop tr.locked{ display:none; }

  /* “faltam pontos” + buzz */
  .need{ font-size:12px; color:#93c5fd; opacity:.95; margin-top:4px }
  @keyframes buzz{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-2px)} 40%{transform:translateX(2px)} 60%{transform:translateX(-1px)} 80%{transform:translateX(1px)} }
  .buzz{ animation:buzz .15s linear 2 }

  @keyframes flashG{ from{box-shadow:0 0 0 2px rgba(16,185,129,.55)} to{box-shadow:0 0 0 10px rgba(16,185,129,0)} }
  .flashG{ animation:flashG .42s ease-out 1; }

  /* evita highlight azul no mobile e seleção de texto */
  .shop tbody tr{ -webkit-tap-highlight-color:transparent; user-select:none; }

  /* Responsivo */
  @media (max-width: 980px){
    :root{ --sidew: 1fr }
    .grid{ grid-template-columns: 1fr; }
    .stage{ min-height: 54vh; }
    .shop-card{ min-height: auto; }
    .upgrades-card{ min-height: auto; }
  }

  /* ===== Colapso da Namorada ===== */
  body.collapse-active{ overflow:hidden; }
  .collapse-overlay{
    position:fixed;
    inset:0;
    display:none;
    flex-direction:column;
    padding:32px clamp(18px, 4vw, 48px) 38px;
    gap:24px;
    background:rgba(6,10,18,0.92);
    color:#f8fafc;
    z-index:120;
    font-family:'Fira Code', 'IBM Plex Mono', 'SFMono-Regular', Menlo, monospace;
    letter-spacing:.02em;
    text-shadow:0 0 18px rgba(96,165,250,.35);
    backdrop-filter:blur(9px) saturate(220%);
    pointer-events:auto;
  }
  .collapse-overlay.active{ display:flex; }
  .collapse-top{
    font-size:clamp(1.1rem, 1.3rem + .6vw, 1.9rem);
    text-transform:uppercase;
    align-self:center;
    letter-spacing:.32em;
    position:relative;
    padding:8px 18px;
    border:1px solid rgba(148,163,184,.35);
    border-radius:999px;
    overflow:hidden;
    mix-blend-mode:screen;
    animation:collapseTopJitter .45s steps(4) infinite;
  }
  .collapse-top::after{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(120deg, rgba(96,165,250,.35) 0%, rgba(15,23,42,.0) 40%, rgba(96,165,250,.35) 100%);
    mix-blend-mode:color-dodge;
    opacity:.32;
    animation:collapseScan 1.6s linear infinite;
  }
  .collapse-center{ display:flex; align-items:center; justify-content:center; position:relative; }
  .collapse-button{
    position:relative;
    padding:28px clamp(40px, 12vw, 160px);
    border-radius:999px;
    border:3px solid rgba(248,113,113,.8);
    background:radial-gradient(circle at center, rgba(248,113,113,.95) 0%, rgba(127,29,29,.92) 60%, rgba(15,23,42,.92) 100%);
    color:#fff1f2;
    font-size:clamp(1.35rem, 1.2rem + 1vw, 2.2rem);
    letter-spacing:.6em;
    text-transform:uppercase;
    cursor:pointer;
    box-shadow:0 0 60px rgba(244,63,94,.55), 0 0 0 3px rgba(244,63,94,.35);
    filter:saturate(1.3);
    transition:filter .12s ease, transform .08s ease;
    animation:collapseButtonPulse 1.2s ease-in-out infinite alternate;
    overflow:hidden;
    user-select:none;
  }
  .collapse-button::after{
    content:'';
    position:absolute;
    inset:-60%;
    background:radial-gradient(circle, rgba(255,228,230,.22) 0%, rgba(255,255,255,0) 70%);
    opacity:.65;
    animation:collapseButtonGlow 1.8s ease-in-out infinite;
    pointer-events:none;
  }
  .collapse-button::before{
    content:'';
    position:absolute;
    inset:-8px;
    border-radius:inherit;
    border:1px solid rgba(255,255,255,.25);
    opacity:.3;
    filter:blur(0);
    transition:opacity .1s ease;
    pointer-events:none;
  }
  .collapse-button:hover{ filter:brightness(1.08) contrast(1.08); }
  .collapse-button.hover-stutter{ animation:collapseButtonStutter .18s steps(4) 1, collapseButtonPulse 1.2s ease-in-out infinite alternate; }
  .collapse-button.burst::after{
    animation:collapseButtonBurst .32s ease-out 1;
  }
  .collapse-button.burst::before{
    opacity:.8;
    animation:collapseButtonRing .28s ease-out 1;
  }
  .collapse-center::after{
    content:'';
    position:absolute;
    inset:0;
    border-radius:24px;
    box-shadow:0 0 0 2px rgba(248,113,113,.25), 0 0 120px rgba(248,113,113,.25);
    opacity:.6;
    filter:blur(1px);
    pointer-events:none;
  }
  .collapse-overlay .collapse-button{ transform:translate(var(--collapse-offset-x, 0px), var(--collapse-offset-y, 0px)); }

  .collapse-code{
    flex:1;
    min-height:180px;
    position:relative;
    padding:24px clamp(14px, 6vw, 28px);
    background:linear-gradient(180deg, rgba(15,23,42,.65) 0%, rgba(8,12,20,.92) 100%);
    border:1px solid rgba(96,165,250,.26);
    border-radius:20px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    gap:6px;
    font-size:.82rem;
    line-height:1.3;
  }
  .collapse-code-lines{
    position:relative;
    display:flex;
    flex-direction:column;
    gap:6px;
    z-index:1;
    min-height:100%;
  }
  .collapse-code::before{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(180deg, rgba(59,130,246,.22) 0%, rgba(15,23,42,0) 40%, rgba(148,163,184,.18) 70%, rgba(15,23,42,0) 100%);
    mix-blend-mode:screen;
    opacity:.55;
    animation:collapseCodeSweep 3.6s linear infinite;
    pointer-events:none;
  }
  .collapse-code::after{
    content:'';
    position:absolute;
    inset:0;
    background:linear-gradient(0deg, rgba(15,23,42,0) 0%, rgba(15,23,42,.86) 85%);
    pointer-events:none;
  }
  .collapse-code-line{
    position:relative;
    color:rgba(165,180,252,.92);
    text-shadow:0 0 10px rgba(129,140,248,.35);
    white-space:pre;
    mix-blend-mode:screen;
  }
  .collapse-code-line.fade{
    opacity:.45;
    color:rgba(148,163,184,.6);
  }
  .collapse-bars{
    position:absolute;
    inset:12px 16px;
    display:flex;
    flex-direction:column;
    gap:8px;
    pointer-events:none;
    opacity:0;
    transition:opacity .18s ease;
  }
  .collapse-bars.active{ opacity:.92; }
  .collapse-bar{
    height:10px;
    border-radius:999px;
    background:rgba(30,41,59,.65);
    overflow:hidden;
    border:1px solid rgba(148,163,184,.28);
  }
  .collapse-bar span{
    display:block;
    height:100%;
    background:linear-gradient(90deg, rgba(59,130,246,.6), rgba(14,165,233,.85));
    box-shadow:0 0 16px rgba(14,165,233,.35);
    transform-origin:left;
    animation:collapseBarLoop 2.4s cubic-bezier(.4,0,.2,1) infinite;
  }

  .collapse-overlay .glyph-swap::after{
    content:'';
    position:absolute;
    inset:0;
    mix-blend-mode:difference;
    pointer-events:none;
  }

  .collapse-overlay.co-negative{ animation:collapseNegative 0.62s steps(2) infinite; }
  .collapse-overlay.co-aberration::before,
  .collapse-overlay.co-aberration::after{
    content:'';
    position:absolute;
    inset:0;
    pointer-events:none;
    mix-blend-mode:screen;
  }
  .collapse-overlay.co-aberration::before{
    background:rgba(59,130,246,.35);
    transform:translateX(-4px);
  }
  .collapse-overlay.co-aberration::after{
    background:rgba(244,114,182,.35);
    transform:translateX(4px);
  }
  .collapse-overlay.co-solar{ filter:contrast(1.2) brightness(1.35) saturate(1.4); }
  .collapse-overlay.co-pixel{ image-rendering:pixelated; }
  .collapse-overlay.co-dither{ background-image:repeating-linear-gradient(135deg, rgba(15,23,42,.9) 0 6px, rgba(241,245,249,.12) 6px 12px); }
  .collapse-overlay.co-kaleido{
    mask-image:radial-gradient(circle at center, rgba(255,255,255,.4) 0%, rgba(255,255,255,0) 60%);
    animation:collapseKaleido 0.18s steps(2) 1;
  }
  .collapse-overlay.co-stutter{ animation:collapseStutter 0.52s steps(2) 1; }
  .collapse-overlay.co-repeat{ animation:collapseRepeat 0.74s steps(3) 1; }
  .collapse-overlay.co-gravity::before{
    animation:collapseGravity 0.6s ease-in-out infinite;
  }
  .collapse-overlay.co-freeze::before{
    animation:none;
    filter:brightness(1.4);
  }
  .collapse-overlay.co-trail::before{
    animation:collapseTrail 1s linear infinite;
  }
  .collapse-overlay.co-code-invert{ filter:invert(1) hue-rotate(180deg); }

  .wrap.collapse-roll{ animation:collapseRoll 0.32s ease-in-out 1; }
  .wrap.collapse-fov{ animation:collapseFov 0.9s ease-in-out 1; }
  .wrap.collapse-zoom{ animation:collapseZoom 0.42s cubic-bezier(.77,-0.2,.34,1.4) 1; }
  .wrap.collapse-zflicker{ animation:collapseZFlicker 0.8s steps(2) infinite; }

  .stage.collapse-rubber{ animation:collapseRubber 0.8s ease-in-out 1; }
  .stage.collapse-uv{ animation:collapseUV 1.1s ease-in-out 1; }
  .stage.collapse-normals{ animation:collapseNormals 0.12s steps(2) 1; }

  body.collapse-active .pill,
  body.collapse-active #pts,
  body.collapse-active #pc,
  body.collapse-active #mps,
  body.collapse-active #statBanco,
  body.collapse-active #statTempo,
  body.collapse-active #statConstr,
  body.collapse-active #statMps,
  body.collapse-active #statClique,
  body.collapse-active #statCliques{ transition:all .2s ease; }
  body.collapse-active.co-ui-numbers .pill b,
  body.collapse-active.co-ui-numbers #pts,
  body.collapse-active.co-ui-numbers #pc,
  body.collapse-active.co-ui-numbers #mps,
  body.collapse-active.co-ui-numbers #statBanco,
  body.collapse-active.co-ui-numbers #statTempo,
  body.collapse-active.co-ui-numbers #statConstr,
  body.collapse-active.co-ui-numbers #statMps,
  body.collapse-active.co-ui-numbers #statClique,
  body.collapse-active.co-ui-numbers #statCliques{
    font-feature-settings:'tnum' 1, 'zero' 1;
    text-shadow:0 0 14px rgba(147,197,253,.6);
  }
  body.collapse-active.co-ui-font{ font-family:'Fira Code', 'IBM Plex Mono', 'SFMono-Regular', Menlo, monospace; }
  .collapse-overlay.co-ui-keys{ border-image:linear-gradient(45deg, rgba(244,114,182,.35), rgba(56,189,248,.35)) 1; }

  .collapse-code.co-code-hex{ color:#99f6e4; }
  .collapse-code.co-code-stack{ color:#fbcfe8; }
  .collapse-code.co-code-console{ color:#bae6fd; }

  .collapse-overlay.co-ui-cursor .collapse-button::before{ opacity:.65; }

  .collapse-overlay.collapse-flash{
    animation:collapseFlash 0.12s steps(2) 1;
  }

  @keyframes collapseTopJitter{
    0%,100%{ transform:translateX(0); }
    25%{ transform:translateX(2px); }
    50%{ transform:translateX(-2px); }
    75%{ transform:translateX(1px); }
  }
  @keyframes collapseScan{
    0%{ transform:translateX(-60%); }
    100%{ transform:translateX(60%); }
  }
  @keyframes collapseButtonPulse{
    from{ filter:brightness(1.05) drop-shadow(0 0 18px rgba(248,113,113,.45)); }
    to{ filter:brightness(1.18) drop-shadow(0 0 28px rgba(248,113,113,.72)); }
  }
  @keyframes collapseButtonGlow{
    0%,100%{ transform:scale(1); opacity:.6; }
    50%{ transform:scale(1.15); opacity:.85; }
  }
  @keyframes collapseButtonStutter{
    0%{ transform:translate(0,0); }
    50%{ transform:translate(-2px,1px); }
    100%{ transform:translate(2px,-1px); }
  }
  @keyframes collapseButtonBurst{
    0%{ transform:scale(1); opacity:.8; }
    50%{ transform:scale(1.25); opacity:.35; }
    100%{ transform:scale(1.5); opacity:0; }
  }
  @keyframes collapseButtonRing{
    0%{ transform:scale(1); opacity:.6; }
    100%{ transform:scale(1.35); opacity:0; }
  }
  @keyframes collapseCodeSweep{
    0%{ transform:translateY(-100%); }
    100%{ transform:translateY(100%); }
  }
  @keyframes collapseBarLoop{
    0%{ transform:scaleX(0); }
    40%{ transform:scaleX(.6); }
    70%{ transform:scaleX(1); }
    100%{ transform:scaleX(0); }
  }
  @keyframes collapseNegative{
    0%,100%{ filter:invert(0); }
    30%{ filter:invert(1) saturate(1.4); }
    60%{ filter:invert(.4) contrast(1.4); }
  }
  @keyframes collapseKaleido{
    0%{ transform:scale(1) rotate(0deg); }
    50%{ transform:scale(1.1) rotate(8deg); }
    100%{ transform:scale(.94) rotate(-6deg); }
  }
  @keyframes collapseStutter{
    0%,50%,100%{ transform:translateX(0); }
    20%{ transform:translateX(-4px); }
    70%{ transform:translateX(6px); }
  }
  @keyframes collapseRepeat{
    0%,100%{ filter:contrast(1); }
    30%{ filter:contrast(1.6); }
    60%{ filter:contrast(.7); }
  }
  @keyframes collapseGravity{
    0%{ transform:translateY(0); }
    100%{ transform:translateY(-10px); }
  }
  @keyframes collapseTrail{
    0%{ transform:skewX(0); }
    100%{ transform:skewX(-12deg); }
  }
  @keyframes collapseFlash{
    0%{ filter:invert(1) brightness(1.6); }
    100%{ filter:none; }
  }
  @keyframes collapseRoll{
    0%{ transform:rotate(0deg); }
    50%{ transform:rotate(2deg); }
    100%{ transform:rotate(-2deg); }
  }
  @keyframes collapseFov{
    0%{ transform:perspective(800px) scale(1); }
    50%{ transform:perspective(500px) scale(1.12); }
    100%{ transform:perspective(800px) scale(1); }
  }
  @keyframes collapseZoom{
    0%{ transform:scale(1); }
    60%{ transform:scale(1.18); }
    100%{ transform:scale(1); }
  }
  @keyframes collapseZFlicker{
    0%,100%{ filter:none; }
    40%{ filter:brightness(1.4) contrast(1.5); }
    70%{ filter:brightness(.7) contrast(.8); }
  }
  @keyframes collapseRubber{
    0%{ transform:scale(1); }
    40%{ transform:scale(1.05, .94); }
    70%{ transform:scale(.96, 1.06); }
    100%{ transform:scale(1); }
  }
  @keyframes collapseUV{
    0%{ transform:skewX(0deg); }
    50%{ transform:skewX(12deg); }
    100%{ transform:skewX(-8deg); }
  }
  @keyframes collapseNormals{
    0%,100%{ filter:none; }
    50%{ filter:invert(1); }
  }

  @media (max-width:720px){
    .collapse-button{ letter-spacing:.3em; padding:24px 36px; }
    .collapse-top{ letter-spacing:.18em; }
  }
</style>

<div class="wrap">
  <!-- TOPO -->
  <header>
    <h1>Memarkez</h1>
    <div class="stats">
      <span class="pill">Meminha: <b id="pts">0</b></span>
      <span class="pill">Por clique: <b id="pc">1</b></span>
      <span class="pill">MPS: <b id="mps">0</b></span>
      <button class="btn settings-btn" id="openSettings" aria-haspopup="dialog">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H2a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 3.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9c.27.51.41 1.08.4 1.66V11a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        Configurações
      </button>
    </div>
  </header>

  <!-- GRID -->
  <main class="grid">
    <aside class="card upgrades-card">
      <h3 class="upgrades-title">Upgrades</h3>
      <p class="muted upgrades-sub">Desbloqueie melhorias comprando prédios específicos e conquiste cliques mais fortes.</p>
      <div id="upgradesGrid" class="upgrade-grid"></div>
    </aside>

    <section class="stage">
      <img id="click" class="click-img" src="imagens/variacoes-mema/mema_back.png" alt="Clique no seu Mema">
    </section>

    <aside class="card shop-card">
      <div class="shop-title">Loja</div>
      <table class="shop">
        <thead>
          <tr>
            <th>Item</th>
            <th>+MPS</th>
            <th>Qtde</th>
          </tr>
        </thead>
        <tbody id="shopBody"></tbody>
      </table>
      <p class="muted" style="margin-top:8px">Passe o mouse e clique na linha para comprar. Itens seguintes aparecem somente após comprar 1 do anterior.</p>
    </aside>
  </main>
</div>

<div id="settingsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <h2>Configurações</h2>
      <button class="modal-close" id="closeSettings" aria-label="Fechar">×</button>
    </div>
    <div class="modal-tabs" role="tablist">
      <button class="modal-tab active" data-tab="config" role="tab" aria-selected="true">Geral</button>
      <button class="modal-tab" data-tab="upgrades" role="tab" aria-selected="false">Melhorias</button>
      <button class="modal-tab" data-tab="achievements" role="tab" aria-selected="false">Conquistas</button>
    </div>
    <div class="modal-content">
      <div class="modal-panel active" data-panel="config" role="tabpanel">
        <p class="muted">Gerencie seu progresso e preferências.</p>
        <button class="btn" id="redeemCode" style="margin-top:12px;max-width:220px;">Inserir código</button>
        <button class="btn" id="deleteSave" style="margin-top:12px;max-width:220px;border-color:#3a2224;background:#24181a;color:#ef4444">Apagar save</button>
      </div>
      <div class="modal-panel" data-panel="upgrades" role="tabpanel" aria-hidden="true">
        <div class="stats-grid">
          <div class="stat-card"><span>Meminhas no banco</span><strong id="statBanco">0</strong></div>
          <div class="stat-card"><span>Tempo de jogo</span><strong id="statTempo">0:00</strong></div>
          <div class="stat-card"><span>Construções obtidas</span><strong id="statConstr">0</strong></div>
          <div class="stat-card"><span>Meminhas por segundo</span><strong id="statMps">0</strong></div>
          <div class="stat-card"><span>Meminhas por clique</span><strong id="statClique">0</strong></div>
          <div class="stat-card"><span>Cliques no Meminha</span><strong id="statCliques">0</strong></div>
        </div>
        <div class="collection-header">
          <h3 style="margin:0">Coleção de melhorias</h3>
          <span class="collection-count" id="collectionCount">Você tem 0/0 melhorias</span>
        </div>
        <div class="collection-section">
          <div class="collection-grid" id="ownedUpgradesGrid"></div>
          <aside class="collection-details" id="collectionDetails">
            <h4 id="collectionDetailName">Selecione uma melhoria</h4>
            <p id="collectionDetailEffect">Passe o mouse ou toque em uma melhoria para ver detalhes.</p>
            <div class="collection-detail-meta">
              <div>
                <span class="label">Custo</span>
                <strong id="collectionDetailCost">—</strong>
              </div>
              <div>
                <span class="label">Requisitos</span>
                <ul id="collectionDetailRequirements"><li>—</li></ul>
              </div>
            </div>
            <div class="collection-detail-ownership" id="collectionDetailOwnership"></div>
          </aside>
        </div>
      </div>
      <div class="modal-panel" data-panel="achievements" role="tabpanel" aria-hidden="true">
        <div class="achievements-header">
          <h3 style="margin:0">Conquistas</h3>
          <span class="collection-count" id="achievementsCount">Você desbloqueou 0/0 conquistas</span>
        </div>
        <div class="achievements-grid" id="achievementsGrid"></div>
      </div>
    </div>
  </div>
</div>

<div id="collapseOverlay" class="collapse-overlay" aria-hidden="true">
  <div class="collapse-top">A realidade não permite isso...</div>
  <div class="collapse-center">
    <button id="collapseDeleteButton" class="collapse-button" type="button">APAGAR SAVE</button>
  </div>
  <div class="collapse-code" id="collapseCodeStream" aria-hidden="true">
    <div class="collapse-bars" id="collapseBars"></div>
    <div class="collapse-code-lines" id="collapseCodeLines"></div>
  </div>
</div>

<div id="saveToast" class="save-toast">salvo</div>
<div id="achievementToast" class="achievement-toast" aria-live="polite"></div>

<div id="upgradeTooltip" class="tooltip-card" role="tooltip" aria-hidden="true">
  <div class="tooltip-name"></div>
  <div class="tooltip-effect"></div>
  <div class="tooltip-cost"></div>
</div>

<script>
/* ===== Estado do jogo ===== */
let pts = 0, clickPow = 1, mps = 0;
let playTimeSeconds = 0;
let totalClicks = 0;
let upgradesState = null;
let achievementsState = null;
let migratedLegacyUpgrades = false;
let selectedCollectionUpgradeId = null;
let redeemedCodes = new Set();

const wrapEl = document.querySelector('.wrap');
const stageEl = document.querySelector('.stage');
const collapseOverlayEl = document.getElementById('collapseOverlay');
const collapseButtonEl = document.getElementById('collapseDeleteButton');
const redeemCodeButtonEl = document.getElementById('redeemCode');

const CODE_REWARDS = {
  entreak: 1_000_000_000_000_000
};
const collapseCodeEl = document.getElementById('collapseCodeStream');
const collapseCodeLinesEl = document.getElementById('collapseCodeLines');
const collapseBarsEl = document.getElementById('collapseBars');

const collapseState = {
  active:false,
  startTime:0,
  loopTimer:null,
  codeTimer:null,
  eventTimers:new Map(),
  lastRun:new Map(),
  codeModes:new Set(),
  magnetStrength:6,
  magnetActive:false,
  magnetPolarity:-1,
  consoleListener:null
};

/* Imagens (efeito clique) */
const IMG_BACK  = 'imagens/variacoes-mema/mema_back.png';
const IMG_FRONT = 'imagens/variacoes-mema/mema_front.png';
const FRONT_TIME_MS = 400;
let faceTimer = null;

/* Helpers */
const el=(id)=>document.getElementById(id);
/* formatação curta legível (K/M/B/T) */
function fmtShort(n){
  const abs = Math.abs(n);
  if(abs >= 1e12) return (n/1e12).toFixed(3)+'T';
  if(abs >= 1e9)  return (n/1e9 ).toFixed(3)+'B';
  if(abs >= 1e6)  return (n/1e6 ).toFixed(2)+'M';
  if(abs >= 1e3)  return (n/1e3 ).toFixed(2)+'K';
  return Math.floor(n).toString();
}

function fmtTime(seconds){
  const total = Math.max(0, Math.floor(seconds));
  const hours = Math.floor(total / 3600);
  const minutes = Math.floor((total % 3600) / 60);
  const secs = total % 60;
  const base = `${minutes}:${secs.toString().padStart(2,'0')}`;
  return hours > 0 ? `${hours}:${minutes.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}` : base;
}

function randRange(min, max){
  return Math.random() * (max - min) + min;
}

function randInt(min, max){
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function sample(arr){
  if(!arr || !arr.length) return null;
  return arr[Math.floor(Math.random() * arr.length)];
}

function shuffleInPlace(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function getTotalBuildingsOwned(){
  if(typeof SHOP === 'undefined') return 0;
  return SHOP.reduce((sum, it)=> sum + (shopState?.[it.id]?.owned ?? 0), 0);
}

function getPurchasedUpgradeCount(){
  if(typeof UPGRADE_DATA === 'undefined') return 0;
  return UPGRADE_DATA.reduce((acc, up)=> acc + (isUpgradePurchased(up.id) ? 1 : 0), 0);
}

const tooltipCardEl = document.getElementById('upgradeTooltip');
const tooltipNameEl = tooltipCardEl?.querySelector('.tooltip-name') ?? null;
const tooltipEffectEl = tooltipCardEl?.querySelector('.tooltip-effect') ?? null;
const tooltipCostEl = tooltipCardEl?.querySelector('.tooltip-cost') ?? null;
let activeUpgradeTooltip = null;

const COLLAPSE_STACK_FRAMES = [
  'core::love::panic',
  'engine::soul::commit',
  'memory::erase::save',
  'hearts::runtime::alloc',
  'render::affection::kaleido',
  'destiny::branch::fork',
  'timeline::rollback::force'
];

const COLLAPSE_CONSOLE_RESPONSES = [
  'permit:false',
  'rollback() -> denied',
  'throw ForbiddenRomance',
  'save.locked // true',
  'trace destiny::loop',
  'echo NULL_HEART',
  'panic! core dumped'
];

const COLLAPSE_STATUS_CODES = [
  '0xDEAD BEEF',
  '0xFEED FACE',
  '0xBADC0DE',
  '0xBAADF00D',
  '0xCAFEBABE',
  '0xF0 0D AD',
  'SIGABRT',
  'NULL',
  'NaN',
  '∞'
];

function randomHexChunk(){
  return Math.floor(Math.random() * 256).toString(16).padStart(2,'0').toUpperCase();
}

function randomAddress(){
  return Math.floor(Math.random() * 0xffff).toString(16).padStart(4,'0').toUpperCase();
}

function randomHexLine(){
  const count = randInt(4, 10);
  const bytes = Array.from({length:count}, randomHexChunk).join(' ');
  return `${randomAddress()}: ${bytes}`;
}

function randomStackLine(){
  const fn = sample(COLLAPSE_STACK_FRAMES) ?? 'core::unknown::??';
  const file = sample(['reality.rs','timeline.cpp','affection.lua','destiny.kt','rollback.ts']) ?? 'memory.js';
  const line = randInt(12, 420);
  return `at ${fn} (${file}:${line})`;
}

function randomConsoleLine(){
  return `console> ${sample(COLLAPSE_CONSOLE_RESPONSES) ?? 'permit:false'}`;
}

function randomStatusLine(){
  const code = sample(COLLAPSE_STATUS_CODES) ?? '0x0000';
  const addr = randomAddress();
  const seed = Math.floor(randRange(1000,9999));
  const verbs = sample(['destiny','collapse','rollback','sync','erase']) ?? 'collapse';
  return `${verbs} :: ${code} // seed:${seed} @${addr}`;
}

function nextCollapseLine(){
  const modes = collapseState.codeModes.size ? Array.from(collapseState.codeModes) : [];
  if(!modes.includes('hex')) modes.push('hex');
  const mode = sample(modes) ?? 'hex';
  switch(mode){
    case 'stack':
      return randomStackLine();
    case 'console':
      return randomConsoleLine();
    case 'hex':
    default:
      return Math.random() < 0.4 ? randomStatusLine() : randomHexLine();
  }
}

function appendCollapseLine(text){
  if(!collapseCodeLinesEl) return;
  const line = document.createElement('div');
  line.className = 'collapse-code-line';
  line.textContent = text;
  collapseCodeLinesEl.appendChild(line);
  const limit = 60;
  while(collapseCodeLinesEl.children.length > limit){
    collapseCodeLinesEl.removeChild(collapseCodeLinesEl.firstChild);
  }
  const lines = collapseCodeLinesEl.querySelectorAll('.collapse-code-line');
  lines.forEach((el, idx)=>{
    if(!(el instanceof HTMLElement)) return;
    el.classList.toggle('fade', idx < lines.length - 12);
  });
  if(collapseCodeEl) collapseCodeEl.scrollTop = collapseCodeEl.scrollHeight;
}

function clearCollapseLines(){
  if(collapseCodeLinesEl) collapseCodeLinesEl.innerHTML = '';
}

function activateCollapseBars(){
  if(!collapseBarsEl) return;
  collapseBarsEl.innerHTML = '';
  const count = randInt(3, 6);
  for(let i=0;i<count;i++){
    const bar = document.createElement('div');
    bar.className = 'collapse-bar';
    const span = document.createElement('span');
    span.style.animationDuration = `${randRange(1.6,2.8).toFixed(2)}s`;
    span.style.animationDelay = `${-randRange(0,2).toFixed(2)}s`;
    const hue = randInt(180, 360);
    span.style.background = `linear-gradient(90deg, hsla(${hue},80%,64%,.8), hsla(${(hue+60)%360},90%,72%,.95))`;
    bar.appendChild(span);
    collapseBarsEl.appendChild(bar);
  }
  collapseBarsEl.classList.add('active');
}

function deactivateCollapseBars(){
  if(!collapseBarsEl) return;
  collapseBarsEl.classList.remove('active');
  collapseBarsEl.innerHTML = '';
}

function setCollapseMode(mode, enable){
  if(enable){
    collapseState.codeModes.add(mode);
  } else {
    collapseState.codeModes.delete(mode);
  }
}

function getCollapseTarget(id){
  switch(id){
    case 'overlay': return collapseOverlayEl;
    case 'stage': return stageEl;
    case 'wrap': return wrapEl;
    case 'body': return document.body;
    case 'code': return collapseCodeEl;
    case 'bars': return collapseBarsEl;
    default: return null;
  }
}

const COLLAPSE_EVENTS = [
  { id:'screen-negative', target:'overlay', className:'co-negative', minDuration:400, maxDuration:1200, cooldown:2200 },
  { id:'screen-aberration', target:'overlay', className:'co-aberration', minDuration:600, maxDuration:1400, cooldown:2400 },
  { id:'screen-solar', target:'overlay', className:'co-solar', minDuration:800, maxDuration:1200, cooldown:2600 },
  { id:'screen-pixel', target:'overlay', className:'co-pixel', minDuration:700, maxDuration:900, cooldown:2600 },
  { id:'screen-dither', target:'overlay', className:'co-dither', minDuration:1000, maxDuration:1400, cooldown:2800 },
  { id:'geo-rubber', target:'stage', className:'collapse-rubber', minDuration:800, maxDuration:1200, cooldown:2600 },
  { id:'geo-normals', target:'stage', className:'collapse-normals', minDuration:90, maxDuration:150, cooldown:2800 },
  { id:'geo-zflicker', target:'wrap', className:'collapse-zflicker', minDuration:800, maxDuration:1100, cooldown:2600 },
  { id:'geo-uv', target:'stage', className:'collapse-uv', minDuration:1000, maxDuration:1600, cooldown:2600 },
  { id:'geo-kaleido', target:'overlay', className:'co-kaleido', minDuration:60, maxDuration:140, cooldown:2400 },
  { id:'cam-roll', target:'wrap', className:'collapse-roll', minDuration:320, maxDuration:420, cooldown:1500 },
  { id:'cam-fov', target:'wrap', className:'collapse-fov', minDuration:900, maxDuration:1100, cooldown:2000 },
  { id:'cam-repeat', target:'overlay', className:'co-repeat', minDuration:700, maxDuration:900, cooldown:2600 },
  { id:'cam-stutter', target:'overlay', className:'co-stutter', minDuration:520, maxDuration:650, cooldown:2400 },
  { id:'cam-zoom', target:'wrap', className:'collapse-zoom', minDuration:420, maxDuration:520, cooldown:2000 },
  { id:'particles-gravity', target:'overlay', className:'co-gravity', minDuration:600, maxDuration:900, cooldown:2600 },
  { id:'particles-freeze', target:'overlay', className:'co-freeze', minDuration:600, maxDuration:900, cooldown:2600 },
  { id:'particles-trail', target:'overlay', className:'co-trail', minDuration:1000, maxDuration:1300, cooldown:2600 },
  { id:'hud-numbers', target:'body', className:'co-ui-numbers', minDuration:1600, maxDuration:2400, cooldown:4200 },
  { id:'hud-font', target:'body', className:'co-ui-font', minDuration:1600, maxDuration:2600, cooldown:4400 },
  {
    id:'hud-bars', target:'bars', className:'active', minDuration:1600, maxDuration:2400, cooldown:3800,
    onStart:activateCollapseBars,
    onEnd:deactivateCollapseBars
  },
  {
    id:'hud-cursor', target:'overlay', className:'co-ui-cursor', minDuration:1600, maxDuration:2200, cooldown:3600,
    onStart:()=>{
      collapseState.magnetActive = true;
      collapseState.magnetStrength = randRange(8,14);
      collapseState.magnetPolarity = Math.random() < 0.5 ? -1 : 1;
    },
    onEnd:()=>{
      collapseState.magnetActive = false;
      collapseState.magnetStrength = 6;
      collapseState.magnetPolarity = -1;
      resetCollapseButtonOffset();
    }
  },
  { id:'hud-keys', target:'overlay', className:'co-ui-keys', minDuration:1400, maxDuration:2000, cooldown:3600 },
  {
    id:'code-hex', target:'code', className:'co-code-hex', minDuration:1400, maxDuration:2000, cooldown:3400,
    onStart:()=>setCollapseMode('hex', true),
    onEnd:()=>setCollapseMode('hex', false)
  },
  {
    id:'code-stack', target:'code', className:'co-code-stack', minDuration:1400, maxDuration:2200, cooldown:3600,
    onStart:()=>setCollapseMode('stack', true),
    onEnd:()=>setCollapseMode('stack', false)
  },
  {
    id:'code-console', target:'code', className:'co-code-console', minDuration:1600, maxDuration:2600, cooldown:3800,
    onStart:()=>setCollapseMode('console', true),
    onEnd:()=>setCollapseMode('console', false)
  },
  { id:'code-invert', target:'overlay', className:'co-code-invert', minDuration:1000, maxDuration:1600, cooldown:3600 }
];

function activateCollapseEvent(evt){
  const target = getCollapseTarget(evt.target);
  if(!target) return;
  target.classList.add(evt.className);
  if(typeof evt.onStart === 'function') evt.onStart();
  const duration = randRange(evt.minDuration, evt.maxDuration);
  const timer = setTimeout(()=>{
    target.classList.remove(evt.className);
    collapseState.eventTimers.delete(evt.id);
    collapseState.lastRun.set(evt.id, performance.now());
    if(typeof evt.onEnd === 'function') evt.onEnd();
  }, duration);
  collapseState.eventTimers.set(evt.id, timer);
}

function runCollapseEventTick(){
  if(!collapseState.active) return;
  const now = performance.now();
  const available = COLLAPSE_EVENTS.filter(evt=>{
    if(collapseState.eventTimers.has(evt.id)) return false;
    const last = collapseState.lastRun.get(evt.id) ?? 0;
    return (now - last) >= evt.cooldown;
  });
  if(!available.length) return;
  const spawn = randInt(1, Math.min(3, available.length));
  shuffleInPlace(available);
  for(let i=0;i<spawn;i++) activateCollapseEvent(available[i]);
}

function startCollapseLoop(){
  if(collapseState.loopTimer) clearInterval(collapseState.loopTimer);
  collapseState.loopTimer = setInterval(runCollapseEventTick, 900);
}

function stopCollapseLoop(){
  if(collapseState.loopTimer){
    clearInterval(collapseState.loopTimer);
    collapseState.loopTimer = null;
  }
}

function pumpCollapseStream(){
  if(!collapseState.active) return;
  const elapsed = (performance.now() - collapseState.startTime) / 1000;
  let count = 1;
  if(elapsed > 10){
    count = randInt(2, 4);
  } else if(elapsed > 3){
    count = randInt(1, 3);
  }
  for(let i=0;i<count;i++) appendCollapseLine(nextCollapseLine());
}

function startCollapseStream(){
  pumpCollapseStream();
  if(collapseState.codeTimer) clearInterval(collapseState.codeTimer);
  collapseState.codeTimer = setInterval(pumpCollapseStream, 260);
}

function stopCollapseStream(){
  if(collapseState.codeTimer){
    clearInterval(collapseState.codeTimer);
    collapseState.codeTimer = null;
  }
}

function resetCollapseButtonOffset(){
  if(!collapseButtonEl) return;
  collapseButtonEl.style.removeProperty('--collapse-offset-x');
  collapseButtonEl.style.removeProperty('--collapse-offset-y');
}

function handleCollapsePointerMove(ev){
  if(!collapseState.active || !collapseButtonEl) return;
  const rect = collapseButtonEl.getBoundingClientRect();
  const centerX = rect.left + rect.width/2;
  const centerY = rect.top + rect.height/2;
  const dx = centerX - ev.clientX;
  const dy = centerY - ev.clientY;
  const dist = Math.hypot(dx, dy) || 1;
  const threshold = 180;
  if(dist > threshold){
    resetCollapseButtonOffset();
    return;
  }
  const ratio = (threshold - dist) / threshold;
  const strength = collapseState.magnetActive ? collapseState.magnetStrength : 6;
  const polarity = collapseState.magnetPolarity ?? -1;
  const base = ratio * strength;
  const offsetX = (dx / dist) * base * (polarity === 1 ? -1 : 1);
  const offsetY = (dy / dist) * base * (polarity === 1 ? -1 : 1);
  collapseButtonEl.style.setProperty('--collapse-offset-x', `${offsetX.toFixed(1)}px`);
  collapseButtonEl.style.setProperty('--collapse-offset-y', `${offsetY.toFixed(1)}px`);
}

function handleCollapseButtonHover(){
  if(!collapseButtonEl) return;
  collapseButtonEl.classList.add('hover-stutter');
  setTimeout(()=> collapseButtonEl.classList.remove('hover-stutter'), 220);
}

function handleCollapseButtonLeave(){
  resetCollapseButtonOffset();
}

function handleCollapseButtonClick(){
  if(!collapseState.active) return;
  if(collapseOverlayEl){
    collapseOverlayEl.classList.add('collapse-flash');
    setTimeout(()=> collapseOverlayEl?.classList.remove('collapse-flash'), 140);
  }
  if(collapseButtonEl){
    collapseButtonEl.classList.add('burst');
    setTimeout(()=> collapseButtonEl?.classList.remove('burst'), 320);
  }
  appendCollapseLine('!! purge.save -> TRUE');
  appendCollapseLine(randomStatusLine());
  setTimeout(()=>{
    deleteSave(true);
    stopCollapseSequence();
  }, 200);
}

function formatCollapseKey(key){
  if(key.length === 1) return key;
  if(key === ' ') return 'SPACE';
  return key.toUpperCase();
}

function handleCollapseKey(ev){
  if(!collapseState.active) return;
  const key = formatCollapseKey(ev.key);
  appendCollapseLine(`console> permit:false // ${key}`);
  ev.preventDefault();
}

function triggerCollapseSequence(fromLoad=false){
  if(collapseState.active) return;
  collapseState.active = true;
  collapseState.startTime = performance.now();
  document.body.classList.add('collapse-active');
  if(collapseOverlayEl){
    collapseOverlayEl.classList.add('active');
    collapseOverlayEl.setAttribute('aria-hidden','false');
  }
  clearCollapseLines();
  appendCollapseLine(fromLoad ? '!! destino reabre ferida antiga' : '!! reality.reject("namorada")');
  appendCollapseLine(randomStatusLine());
  collapseState.magnetStrength = 6;
  collapseState.magnetPolarity = -1;
  collapseState.magnetActive = false;
  collapseState.eventTimers.forEach(timer=> clearTimeout(timer));
  collapseState.eventTimers.clear();
  collapseState.lastRun.clear();
  collapseState.codeModes.clear();
  deactivateCollapseBars();
  stopCollapseLoop();
  stopCollapseStream();
  startCollapseLoop();
  startCollapseStream();
  resetCollapseButtonOffset();
  if(!collapseState.consoleListener){
    collapseState.consoleListener = handleCollapseKey;
    document.addEventListener('keydown', collapseState.consoleListener, true);
  }
}

function stopCollapseSequence(){
  if(!collapseState.active) return;
  collapseState.active = false;
  stopCollapseLoop();
  stopCollapseStream();
  collapseState.eventTimers.forEach(timer=> clearTimeout(timer));
  collapseState.eventTimers.clear();
  collapseState.lastRun.clear();
  collapseState.codeModes.clear();
  if(collapseOverlayEl){
    collapseOverlayEl.classList.remove('active','co-negative','co-aberration','co-solar','co-pixel','co-dither','co-kaleido','co-repeat','co-stutter','co-gravity','co-freeze','co-trail','co-code-invert','co-ui-keys','co-ui-cursor');
    collapseOverlayEl.setAttribute('aria-hidden','true');
  }
  if(collapseCodeEl) collapseCodeEl.classList.remove('co-code-hex','co-code-stack','co-code-console');
  if(stageEl) stageEl.classList.remove('collapse-rubber','collapse-uv','collapse-normals');
  if(wrapEl) wrapEl.classList.remove('collapse-roll','collapse-fov','collapse-zoom','collapse-zflicker');
  document.body.classList.remove('collapse-active','co-ui-numbers','co-ui-font');
  deactivateCollapseBars();
  resetCollapseButtonOffset();
  if(collapseState.consoleListener){
    document.removeEventListener('keydown', collapseState.consoleListener, true);
    collapseState.consoleListener = null;
  }
}

function refreshUpgradeTooltip(up){
  if(!tooltipCardEl || !tooltipNameEl || !tooltipEffectEl || !tooltipCostEl) return;
  tooltipNameEl.textContent = up.name;

  const benefits = getUpgradeBenefitLines(up);
  tooltipEffectEl.textContent = benefits.length ? benefits.join(' • ') : 'Sem efeito adicional';

  const cost = up.cost ?? 0;
  const purchased = isUpgradePurchased(up.id);
  let statusText = '';
  if(purchased){
    statusText = 'Já comprado';
  } else if(pts >= cost){
    statusText = 'Pode comprar';
  } else {
    const missing = Math.max(0, cost - pts);
    statusText = `Faltam ${fmtShort(missing)} pontos`;
  }
  tooltipCostEl.textContent = `Custo: ${fmtShort(cost)} – ${statusText}`;
}

function positionUpgradeTooltip(target, evt){
  if(!tooltipCardEl || !activeUpgradeTooltip) return;
  if(!target?.isConnected){
    hideUpgradeTooltip();
    return;
  }

  const rect = target.getBoundingClientRect();
  const width = tooltipCardEl.offsetWidth;
  const height = tooltipCardEl.offsetHeight;
  const padding = 16;

  let left = (evt?.clientX ?? rect.left + rect.width / 2) - width / 2;
  let top = (evt?.clientY ?? rect.top) - height - padding;

  if(top < 12){
    top = rect.bottom + padding;
  }

  if(left < 12) left = 12;
  const maxLeft = window.innerWidth - width - 12;
  if(left > maxLeft) left = maxLeft;

  const maxTop = window.innerHeight - height - 12;
  if(top > maxTop) top = maxTop;
  if(top < 12) top = 12;

  tooltipCardEl.style.left = `${Math.round(left)}px`;
  tooltipCardEl.style.top = `${Math.round(top)}px`;
}

function showUpgradeTooltip(target, up, evt){
  if(!tooltipCardEl) return;
  activeUpgradeTooltip = { target, up };
  refreshUpgradeTooltip(up);
  tooltipCardEl.setAttribute('aria-hidden', 'false');
  tooltipCardEl.style.visibility = 'hidden';
  tooltipCardEl.classList.add('visible');
  positionUpgradeTooltip(target, evt);
  tooltipCardEl.style.visibility = '';
}

function hideUpgradeTooltip(){
  if(!tooltipCardEl) return;
  activeUpgradeTooltip = null;
  tooltipCardEl.classList.remove('visible');
  tooltipCardEl.setAttribute('aria-hidden', 'true');
}

function repositionActiveUpgradeTooltip(){
  if(!activeUpgradeTooltip) return;
  const target = activeUpgradeTooltip.target;
  if(!target || !target.isConnected){
    hideUpgradeTooltip();
    return;
  }
  if(activeUpgradeTooltip.up){
    refreshUpgradeTooltip(activeUpgradeTooltip.up);
  }
  positionUpgradeTooltip(target);
}

window.addEventListener('scroll', repositionActiveUpgradeTooltip, {passive:true});
window.addEventListener('resize', repositionActiveUpgradeTooltip);

function renderStatsPanel(){
  const bancoEl = el('statBanco');
  if(!bancoEl) return;
  bancoEl.textContent = fmtShort(pts);
  const tempoEl = el('statTempo');
  if(tempoEl) tempoEl.textContent = fmtTime(playTimeSeconds);
  const constrEl = el('statConstr');
  if(constrEl) constrEl.textContent = getTotalBuildingsOwned();
  const mpsEl = el('statMps');
  if(mpsEl) mpsEl.textContent = mps.toFixed(2);
  const cliqueEl = el('statClique');
  if(cliqueEl) cliqueEl.textContent = Math.max(1, Math.floor(clickPow));
  const cliquesEl = el('statCliques');
  if(cliquesEl) cliquesEl.textContent = totalClicks;
  const countEl = el('collectionCount');
  if(countEl && typeof UPGRADE_DATA !== 'undefined') countEl.textContent = `Você tem ${getPurchasedUpgradeCount()}/${UPGRADE_DATA.length} melhorias`;
  const achCountEl = el('achievementsCount');
  if(achCountEl && typeof ACHIEVEMENT_DATA !== 'undefined') achCountEl.textContent = `Você desbloqueou ${getUnlockedAchievementCount()}/${ACHIEVEMENT_DATA.length} conquistas`;
}

function resetCollectionDetail(){
  const nameEl = el('collectionDetailName');
  if(!nameEl) return;
  nameEl.textContent = 'Selecione uma melhoria';
  const effectEl = el('collectionDetailEffect');
  if(effectEl) effectEl.textContent = 'Passe o mouse ou toque em uma melhoria para ver detalhes.';
  const costEl = el('collectionDetailCost');
  if(costEl) costEl.textContent = '—';
  const reqEl = el('collectionDetailRequirements');
  if(reqEl){
    reqEl.innerHTML = '';
    const li = document.createElement('li');
    li.textContent = '—';
    reqEl.appendChild(li);
  }
  const ownershipEl = el('collectionDetailOwnership');
  if(ownershipEl) ownershipEl.textContent = '';
}

function updateCollectionSelectionHighlight(){
  const slots = document.querySelectorAll('.collection-slot');
  slots.forEach(slot=>{
    const isSelected = slot.dataset.upgrade === selectedCollectionUpgradeId;
    slot.classList.toggle('selected', isSelected);
    slot.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
  });
}

function selectCollectionUpgrade(up){
  if(!up){
    selectedCollectionUpgradeId = null;
    updateCollectionSelectionHighlight();
    resetCollectionDetail();
    return;
  }
  selectedCollectionUpgradeId = up.id;
  updateCollectionSelectionHighlight();
  showUpgradeDetails(up);
}

function showUpgradeDetails(up){
  if(!up){
    resetCollectionDetail();
    return;
  }
  const owned = isUpgradePurchased(up.id);
  const nameEl = el('collectionDetailName');
  if(nameEl) nameEl.textContent = owned ? up.name : '?????';
  const effectEl = el('collectionDetailEffect');
  if(effectEl){
    if(owned){
      const benefits = getUpgradeBenefitLines(up);
      effectEl.textContent = benefits.length ? benefits.join(' • ') : 'Melhoria misteriosa';
    } else {
      effectEl.textContent = '???';
    }
  }
  const costEl = el('collectionDetailCost');
  if(costEl) costEl.textContent = owned ? fmtShort(up.cost ?? 0) : '???';
  const reqEl = el('collectionDetailRequirements');
  if(reqEl){
    reqEl.innerHTML = '';
    if(owned){
      const reqLines = getUpgradeRequirementLines(up);
      if(reqLines.length){
        reqLines.forEach(line=>{
          const li = document.createElement('li');
          li.textContent = line;
          reqEl.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'Sem requisitos adicionais';
        reqEl.appendChild(li);
      }
    } else {
      const li = document.createElement('li');
      li.textContent = '???';
      reqEl.appendChild(li);
    }
  }
  const ownershipEl = el('collectionDetailOwnership');
  if(ownershipEl) ownershipEl.textContent = owned ? 'Comprado' : '?????';
}

function renderOwnedUpgradesCollection(){
  const grid = el('ownedUpgradesGrid');
  if(!grid || typeof UPGRADE_DATA === 'undefined'){
    resetCollectionDetail();
    return;
  }
  grid.innerHTML = '';
  const fragment = document.createDocumentFragment();
  UPGRADE_DATA.forEach(up=>{
    const owned = isUpgradePurchased(up.id);
    const slot = document.createElement('div');
    slot.className = 'collection-slot';
    if(owned) slot.classList.add('owned');
    slot.dataset.upgrade = up.id;
    slot.tabIndex = 0;
    slot.setAttribute('role','button');
    slot.setAttribute('aria-label', owned ? up.name : '?????');
    slot.setAttribute('aria-pressed', 'false');

    if(owned){
      const img = document.createElement('img');
      img.src = up.img;
      img.alt = up.name;
      slot.appendChild(img);
    } else {
      const placeholder = document.createElement('div');
      placeholder.className = 'slot-placeholder';
      placeholder.textContent = '?????';
      slot.appendChild(placeholder);
    }

    const handleSelect = ()=> selectCollectionUpgrade(up);
    slot.addEventListener('click', handleSelect);
    slot.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter' || ev.key === ' '){
        ev.preventDefault();
        handleSelect();
      }
    });

    fragment.appendChild(slot);
  });
  grid.appendChild(fragment);
  updateCollectionSelectionHighlight();
  if(selectedCollectionUpgradeId){
    const selected = UPGRADE_MAP[selectedCollectionUpgradeId];
    if(selected){
      showUpgradeDetails(selected);
    } else {
      selectCollectionUpgrade(null);
    }
  } else {
    resetCollectionDetail();
  }
  renderStatsPanel();
}

function isAchievementUnlocked(id){
  const st = achievementsState?.[id];
  return !!(st && st.unlocked);
}

function setAchievementUnlocked(id, value=true){
  if(!achievementsState[id]) achievementsState[id] = {unlocked:false, unlockedAt:null};
  achievementsState[id].unlocked = value;
  achievementsState[id].unlockedAt = value ? Date.now() : null;
}

function getUnlockedAchievementCount(){
  if(typeof ACHIEVEMENT_DATA === 'undefined') return 0;
  return ACHIEVEMENT_DATA.reduce((sum, ach)=> sum + (isAchievementUnlocked(ach.id) ? 1 : 0), 0);
}

function isAchievementRequirementMet(ach){
  if(!ach?.requirement) return false;
  const req = ach.requirement;
  switch(req.type){
    case 'building':
      return (shopState?.[req.building]?.owned ?? 0) >= (req.count ?? 0);
    case 'upgrade-count':
      return getPurchasedUpgradeCount() >= (req.count ?? 0);
    case 'clicks':
      return totalClicks >= (req.count ?? 0);
    default:
      return false;
  }
}

function renderAchievementsPanel(){
  const grid = el('achievementsGrid');
  if(!grid || typeof ACHIEVEMENT_DATA === 'undefined') return;
  grid.innerHTML = '';
  const fragment = document.createDocumentFragment();
  ACHIEVEMENT_DATA.forEach(ach=>{
    const unlocked = isAchievementUnlocked(ach.id);
    const card = document.createElement('div');
    card.className = 'achievement-card';
    card.classList.add(unlocked ? 'unlocked' : 'locked');

    const title = document.createElement('h4');
    title.className = 'achievement-name';
    title.textContent = unlocked ? ach.name : '?????';
    card.appendChild(title);

    const desc = document.createElement('p');
    desc.className = 'achievement-desc';
    desc.textContent = unlocked ? ach.description : '???';
    card.appendChild(desc);

    fragment.appendChild(card);
  });
  grid.appendChild(fragment);

  const countEl = el('achievementsCount');
  if(countEl && typeof ACHIEVEMENT_DATA !== 'undefined'){
    countEl.textContent = `Você desbloqueou ${getUnlockedAchievementCount()}/${ACHIEVEMENT_DATA.length} conquistas`;
  }
}

const achievementToastQueue = [];
let achievementToastShowing = false;
let achievementToastTimer = null;
let achievementToastHideTimer = null;

function dequeueAchievementToast(){
  if(achievementToastShowing) return;
  if(!achievementToastQueue.length) return;
  const toast = el('achievementToast');
  if(!toast) return;
  const message = achievementToastQueue.shift();
  toast.textContent = `Conquista desbloqueada: ${message}`;
  toast.classList.add('show');
  achievementToastShowing = true;
  if(achievementToastTimer) clearTimeout(achievementToastTimer);
  achievementToastTimer = setTimeout(()=>{
    toast.classList.remove('show');
    if(achievementToastHideTimer) clearTimeout(achievementToastHideTimer);
    achievementToastHideTimer = setTimeout(()=>{
      achievementToastShowing = false;
      dequeueAchievementToast();
    }, 420);
  }, 2600);
}

function showAchievementToast(name){
  achievementToastQueue.push(name);
  dequeueAchievementToast();
}

function evaluateAchievements(silent=false){
  if(typeof ACHIEVEMENT_DATA === 'undefined') return;
  let unlockedAny = false;
  ACHIEVEMENT_DATA.forEach(ach=>{
    if(isAchievementUnlocked(ach.id)) return;
    if(isAchievementRequirementMet(ach)){
      setAchievementUnlocked(ach.id, true);
      unlockedAny = true;
      if(!silent) showAchievementToast(ach.name);
    }
  });
  if(unlockedAny){
    renderAchievementsPanel();
    save();
  }
}

function setupSettingsModal(){
  const modal = el('settingsModal');
  const openBtn = el('openSettings');
  const closeBtn = el('closeSettings');
  if(!modal || !openBtn || !closeBtn) return;

  const tabs = Array.from(modal.querySelectorAll('.modal-tab'));
  const panels = Array.from(modal.querySelectorAll('.modal-panel'));

  function setActiveTab(tabId){
    tabs.forEach(btn=>{
      const active = btn.dataset.tab === tabId;
      btn.classList.toggle('active', active);
      btn.setAttribute('aria-selected', active ? 'true' : 'false');
    });
    panels.forEach(panel=>{
      const active = panel.dataset.panel === tabId;
      panel.classList.toggle('active', active);
      panel.setAttribute('aria-hidden', active ? 'false' : 'true');
    });
    if(tabId === 'upgrades'){
      renderOwnedUpgradesCollection();
    } else if(tabId === 'achievements'){
      renderAchievementsPanel();
    } else {
      renderStatsPanel();
    }
  }

  function open(){
    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    setActiveTab('config');
    renderStatsPanel();
  }

  function close(){
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }

  openBtn.addEventListener('click', open);
  closeBtn.addEventListener('click', close);
  modal.addEventListener('click', (ev)=>{
    if(ev.target === modal) close();
  });
  document.addEventListener('keydown', (ev)=>{
    if(ev.key === 'Escape' && modal.classList.contains('open')) close();
  });
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=> setActiveTab(btn.dataset.tab));
  });
}

/* SAVE/LOAD */
let shopState = null; // definido após catálogo
function save(showToast=false){
  localStorage.setItem('mcw', JSON.stringify({
    pts,
    clickPow,
    mps,
    playTimeSeconds,
    totalClicks,
    shopState,
    upgradesState,
    achievementsState,
    codes: Array.from(redeemedCodes)
  }));
  if(showToast) flashSave();
}
function load(){ try{
  migratedLegacyUpgrades = false;
  const d = JSON.parse(localStorage.getItem('mcw')||'{}');
  pts=d.pts??0; clickPow=d.clickPow??1; mps=d.mps??0;
  playTimeSeconds = d.playTimeSeconds ?? d.playTime ?? 0;
  totalClicks = d.totalClicks ?? 0;
  if(d.shopState) shopState = {...makeInitialShopState(), ...d.shopState};
  if(d.upgradesState){
    const base = makeInitialUpgradeState();
    upgradesState = {...base};
    Object.keys(d.upgradesState).forEach(id=>{
      if(!base[id]) return;
      const prev = d.upgradesState[id] || {};
      const purchased = !!(prev.purchased ?? prev.unlocked);
      upgradesState[id] = {...base[id], purchased, unlocked:purchased};
      if(prev.unlocked !== undefined && prev.purchased === undefined){
        migratedLegacyUpgrades = true;
      }
    });
  }
  if(d.achievementsState){
    const base = makeInitialAchievementState();
    achievementsState = {...base};
    Object.keys(d.achievementsState).forEach(id=>{
      if(!base[id]) return;
      const prev = d.achievementsState[id] || {};
      achievementsState[id] = {
        ...base[id],
        unlocked: !!prev.unlocked,
        unlockedAt: prev.unlockedAt ?? null
      };
    });
  }
  const codes = Array.isArray(d.codes) ? d.codes : [];
  redeemedCodes = new Set(codes.map(code=> String(code).toLowerCase()));
} catch(e){} }

/* HUD (topo) */
function renderHUD(){
  el('pts').textContent = fmtShort(pts);
  el('pc').textContent = Math.floor(clickPow);
  el('mps').textContent = mps.toFixed(2);
  // não re-renderiza a loja aqui
  renderStatsPanel();
}

/* feedback imagem */
function showFront(){
  const img = el('click');
  img.src = IMG_FRONT;
  if (faceTimer) clearTimeout(faceTimer);
  faceTimer = setTimeout(()=>{ img.src = IMG_BACK; }, FRONT_TIME_MS);
}

/* reset */
function resetState(){
  pts=0; clickPow=1; mps=0;
  playTimeSeconds = 0;
  totalClicks = 0;
  shopState = makeInitialShopState();
  upgradesState = makeInitialUpgradeState();
  achievementsState = makeInitialAchievementState();
  selectedCollectionUpgradeId = null;
  redeemedCodes = new Set();
  achievementToastQueue.length = 0;
  if(achievementToastTimer) clearTimeout(achievementToastTimer);
  if(achievementToastHideTimer) clearTimeout(achievementToastHideTimer);
  achievementToastTimer = null;
  achievementToastHideTimer = null;
  achievementToastShowing = false;
  const toast = el('achievementToast');
  if(toast) toast.classList.remove('show');
}
function deleteSave(force=false){
  if(!force){
    const ok = confirm('Apagar seu save? Esta ação não pode ser desfeita.');
    if(!ok) return false;
  }
  localStorage.removeItem('mcw');
  resetState();
  renderShop();
  renderUpgrades();
  recalculateProduction();
  evaluateAchievements(true);
  renderAchievementsPanel();
  renderHUD();
  stopCollapseSequence();
  return true;
}

/* loop de meminhas automáticos (MPS) */
function loop(){
  let last=performance.now();
  function tick(){
    const now=performance.now(), dt=(now-last)/1000; last=now;
    pts += mps*dt;
    playTimeSeconds += dt;
    renderHUD();           // atualiza só o topo
    updateAffordability(); // pinta se dá pra comprar, sem recriar DOM
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

/* auto-save + toast */
let saveTimer = null;
function startAutoSave(){
  if(saveTimer) clearInterval(saveTimer);
  saveTimer = setInterval(()=> save(true), 5000);
}
let toastTimer=null;
function flashSave(){
  const t = el('saveToast');
  t.textContent = 'salvo';
  t.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.classList.remove('show'), 1400);
}

function promptAndRedeemCode(){
  if(!redeemCodeButtonEl) return;
  const raw = prompt('Insira o código:');
  if(raw === null) return;
  const normalized = raw.trim().toLowerCase();
  if(!normalized){
    alert('Nenhum código informado.');
    return;
  }
  if(!Object.prototype.hasOwnProperty.call(CODE_REWARDS, normalized)){
    alert('Código inválido.');
    return;
  }
  if(redeemedCodes.has(normalized)){
    alert('Código já utilizado.');
    return;
  }

  const reward = CODE_REWARDS[normalized];
  pts += reward;
  redeemedCodes.add(normalized);
  renderHUD();
  updateAffordability();
  evaluateAchievements();
  save(true);
  alert(`Código resgatado! Você ganhou ${fmtShort(reward)} Meminhas.`);
}

/* preload imagens */
(new Image()).src = IMG_BACK;
(new Image()).src = IMG_FRONT;

/* ===== Loja =====
   Agora usamos as fórmulas exponenciais:
   precoProximo(base, escala, q) = ceil(base * escala^q)
*/

/* Parâmetros sugeridos (base, escala, mps/base) */
const SHOP = [
  {id:'dedo',       name:'Dedo',       base:15,          r:1.07, p:0.10, limit:50},
  {id:'roupa',      name:'Roupa',      base:100,         r:1.10, p:1.00,  limit:20},
  {id:'agua',       name:'Água',       base:1100,        r:1.12, p:8.00,  limit:20},
  {id:'plantacao',  name:'Plantação',  base:12000,       r:1.13, p:47.0,  limit:12},
  {id:'alojamento', name:'Alojamento', base:130000,      r:1.14, p:260.0, limit:8},
  {id:'casa',       name:'Casa',       base:1400000,     r:1.15, p:1400.0,limit:5},
  {id:'xbox',       name:'Xbox',       base:20000000,    r:1.16, p:7800.0, limit:3},
  {id:'computador', name:'Computador', base:330000000,   r:1.17, p:44000.0,limit:3},
  {id:'microfone',  name:'Microfone',  base:5100000000,  r:1.18, p:260000.0,limit:2},
  {id:'namorada',   name:'Namorada',   base:75000000000, r:1.20, p:1600000.0,limit:1}
];

const SHOP_LOOKUP = SHOP.reduce((acc, item)=>{ acc[item.id] = item; return acc; }, {});

const UPGRADE_DATA = [
  {
    id:'up-dedo-t1',
    name:'Mão aprimorada',
    effect:'Cada Dedo gera +1 clique extra',
    cost:5000,
    img:'imagens/melhorias-futuras/up-dedo-t1.png',
    requirement:{type:'building', building:'dedo', count:10},
    requirementText:'Tenha 10 Dedos',
    bonus:{type:'finger', perDedo:1}
  },
  {
    id:'up-dedo-t2',
    name:'Mão de Graphite',
    effect:'Cada Dedo gera +1 clique extra (acumula)',
    cost:250000,
    img:'imagens/melhorias-futuras/up-dedo-t2.png',
    requirement:{type:'building', building:'dedo', count:25},
    requirementText:'Tenha 25 Dedos e o upgrade anterior',
    requires:['up-dedo-t1'],
    bonus:{type:'finger', perDedo:1}
  },
  {
    id:'up-dedo-t3',
    name:'Mão de Slate',
    effect:'Cada Dedo gera +1 clique extra (acumula)',
    cost:10000000,
    img:'imagens/melhorias-futuras/up-dedo-t3.png',
    requirement:{type:'building', building:'dedo', count:40},
    requirementText:'Tenha 40 Dedos e o upgrade anterior',
    requires:['up-dedo-t2'],
    bonus:{type:'finger', perDedo:1}
  },
  {
    id:'up-roupa-t1',
    name:'Tênis Impressionante',
    effect:'+10% MPS gerado por Roupa',
    cost:1000,
    img:'imagens/melhorias-futuras/up-roupa-t1.png',
    requirement:{type:'building', building:'roupa', count:1},
    requirementText:'Compre 1 Roupa',
    bonus:{type:'building', target:'roupa', amount:0.10}
  },
  {
    id:'up-agua-t1',
    name:'Água Salgada',
    effect:'+10% MPS gerado por Água',
    cost:12000,
    img:'imagens/melhorias-futuras/up-agua-t1.png',
    requirement:{type:'building', building:'agua', count:1},
    requirementText:'Compre 1 Água',
    bonus:{type:'building', target:'agua', amount:0.10}
  },
  {
    id:'up-plantacao-t1',
    name:'Fertilizante',
    effect:'+12% MPS gerado por Plantação',
    cost:180000,
    img:'imagens/melhorias-futuras/up-plantacao-t1.png',
    requirement:{type:'building', building:'plantacao', count:1},
    requirementText:'Compre 1 Plantação',
    bonus:{type:'building', target:'plantacao', amount:0.12}
  },
  {
    id:'up-alojamento-t1',
    name:'Cerca',
    effect:'+12% MPS gerado por Alojamento',
    cost:2000000,
    img:'imagens/melhorias-futuras/up-alojamento-t1.png',
    requirement:{type:'building', building:'alojamento', count:1},
    requirementText:'Compre 1 Alojamento',
    bonus:{type:'building', target:'alojamento', amount:0.12}
  },
  {
    id:'up-casa-t1',
    name:'Porta',
    effect:'+15% MPS gerado por Casa',
    cost:30000000,
    img:'imagens/melhorias-futuras/up-casa-t1.png',
    requirement:{type:'building', building:'casa', count:1},
    requirementText:'Compre 1 Casa',
    bonus:{type:'building', target:'casa', amount:0.15}
  },
  {
    id:'up-xbox-t1',
    name:'Controle360',
    effect:'+15% MPS gerado por Xbox',
    cost:450000000,
    img:'imagens/melhorias-futuras/up-xbox-t1.png',
    requirement:{type:'building', building:'xbox', count:1},
    requirementText:'Compre 1 Xbox',
    bonus:{type:'building', target:'xbox', amount:0.15}
  },
  {
    id:'up-computador-t1',
    name:'Ryzen',
    effect:'+18% MPS gerado por Computador',
    cost:6000000000,
    img:'imagens/melhorias-futuras/up-computador-t1.png',
    requirement:{type:'building', building:'computador', count:1},
    requirementText:'Compre 1 Computador',
    bonus:{type:'building', target:'computador', amount:0.18}
  },
  {
    id:'up-microfone-t1',
    name:'Rap de Anime',
    effect:'+20% MPS gerado por Microfone',
    cost:90000000000,
    img:'imagens/melhorias-futuras/up-microfone-t1.png',
    requirement:{type:'building', building:'microfone', count:1},
    requirementText:'Compre 1 Microfone',
    bonus:{type:'building', target:'microfone', amount:0.20}
  }
];

const UPGRADE_MAP = UPGRADE_DATA.reduce((acc, up)=>{ acc[up.id] = up; return acc; }, {});
const upgradeElements = new Map();

const ACHIEVEMENT_DATA = [
  { id:'ach-polidactilia', name:'Polidactilia', description:'Tenha 50 Dedos', requirement:{ type:'building', building:'dedo', count:50 } },
  { id:'ach-calcinha', name:'Calcinha', description:'Tenha 20 Dedos', requirement:{ type:'building', building:'dedo', count:20 } },
  { id:'ach-h20', name:'H20', description:'Tenha 20 Águas', requirement:{ type:'building', building:'agua', count:20 } },
  { id:'ach-stardew', name:'Stardew Valley', description:'Tenha 12 Plantações', requirement:{ type:'building', building:'plantacao', count:12 } },
  { id:'ach-estabulo', name:'Estábulo', description:'Tenha 8 Plantações', requirement:{ type:'building', building:'plantacao', count:8 } },
  { id:'ach-aluguel', name:'Aluguel', description:'Tenha 5 Casas', requirement:{ type:'building', building:'casa', count:5 } },
  { id:'ach-xbox', name:'Xbox One', description:'Tenha 3 Xbox', requirement:{ type:'building', building:'xbox', count:3 } },
  { id:'ach-garoto-programas', name:'Garoto dos programas', description:'Tenha 3 Computadores', requirement:{ type:'building', building:'computador', count:3 } },
  { id:'ach-cantor', name:'Cantor', description:'Tenha 2 Microfones', requirement:{ type:'building', building:'microfone', count:2 } },
  { id:'ach-me-perdoe', name:'Me perdoe pelos meus atos.', description:'Tenha 1 Namorada', requirement:{ type:'building', building:'namorada', count:1 } },
  { id:'ach-pegador', name:'Pegador', description:'Adquira 5 upgrades', requirement:{ type:'upgrade-count', count:5 } },
  { id:'ach-eu-sou', name:'eu sou melhor que todos vocês', description:'Adquira 10 upgrades', requirement:{ type:'upgrade-count', count:10 } },
  { id:'ach-exame', name:'exame de próstata', description:'Clique 100 vezes no Mema', requirement:{ type:'clicks', count:100 } }
];

function makeInitialShopState(){
  const s={};
  SHOP.forEach(it=> s[it.id] = {owned:0});
  return s;
}
if(!shopState) shopState = makeInitialShopState();

function makeInitialUpgradeState(){
  const s={};
  UPGRADE_DATA.forEach(up=> s[up.id] = {purchased:false, unlocked:false});
  return s;
}
if(!upgradesState) upgradesState = makeInitialUpgradeState();

function makeInitialAchievementState(){
  const s={};
  ACHIEVEMENT_DATA.forEach(ach=> s[ach.id] = {unlocked:false, unlockedAt:null});
  return s;
}
if(!achievementsState) achievementsState = makeInitialAchievementState();

/* Fórmulas utilitárias */
function precoProximo(base, escala, qPossuidas){
  return Math.ceil(base * Math.pow(escala, qPossuidas));
}
/* Render da loja — atualiza visibilidade e cores com base em pts e desbloqueio */
function renderShop(){
  const body = document.getElementById('shopBody');
  if(!body) return;
  body.innerHTML='';

  SHOP.forEach((it, idx)=>{
    const st = shopState[it.id];
    const atLimit = st.owned >= it.limit;

    // desbloqueio: item só aparece quando o anterior tiver ao menos 1 comprado
    const locked = idx > 0 && (shopState[SHOP[idx-1].id].owned < 1);

    if(locked){
      // mantém a progressão da loja escondendo completamente itens futuros
      return;
    }

    const tr = document.createElement('tr');
    tr.dataset.buy = it.id;

    tr.className = atLimit ? 'max' : 'clickable';

    // determinar preço da próxima unidade
    const priceSingle = precoProximo(it.base, it.r, st.owned);

    // determinar se pode comprar agora (custo alcançável e não no limite)
    const canAffordSingle = (!atLimit) && (pts >= priceSingle);

    const perUnit = it.p * getBuildingMultiplier(it.id);

    // Se o item estiver desbloqueado mas você ainda não possui NENHUM (owned === 0),
    // mostramos "?????" no lugar do nome para criar surpresa antes da primeira compra.
    const displayName = (!locked && st.owned === 0) ? '?????' : it.name;

    tr.innerHTML = `
      <td class="name">
        <div>${displayName}</div>
        <div class="cost ${canAffordSingle ? 'can' : 'cant'}">Custo: ${fmtShort(priceSingle)}</div>
        <div class="status">${atLimit ? 'MAX' : ''}</div>
      </td>
      <td>+${perUnit.toFixed(2)}</td>
      <td class="owned-limit"><span class="owned">${st.owned}</span><span class="sep">/</span><span class="limit-num">${it.limit}</span></td>
    `;

    // aplica a classe visual de "pode comprar" se o preço couber
    tr.classList.toggle('afford', canAffordSingle);

    if(!locked && !atLimit){
      // clique na linha inteira --> tenta comprar 1 unidade
      tr.addEventListener('click', ()=> {
        tryBuy(it.id);
      });
      // acessibilidade básica (Enter/Space)
      tr.setAttribute('tabindex', '0');
      tr.setAttribute('role','button');
      tr.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          tryBuy(it.id);
        }
      });
    }

    body.appendChild(tr);
  });
}

function isUpgradePurchased(id){
  const st = upgradesState?.[id];
  if(!st) return false;
  if(typeof st.purchased === 'boolean') return st.purchased;
  return !!st.unlocked;
}

function setUpgradePurchased(id, value=true){
  if(!upgradesState[id]) upgradesState[id] = {purchased:false, unlocked:false};
  upgradesState[id].purchased = value;
  upgradesState[id].unlocked = value;
}

function canShowUpgrade(up){
  if(up.requires && up.requires.some(reqId=> !isUpgradePurchased(reqId))) return false;
  const req = up.requirement;
  if(req?.type === 'building'){
    const owned = shopState[req.building]?.owned ?? 0;
    if(owned < req.count) return false;
  }
  return true;
}

function getUpgradeRequirementLines(up){
  const lines = [];
  if(up.requirementText) lines.push(up.requirementText);
  if(up.requirement?.type === 'building' && !up.requirementText){
    const name = SHOP_LOOKUP[up.requirement.building]?.name ?? up.requirement.building;
    const count = up.requirement.count ?? 0;
    lines.push(`Compre ${count} ${name}`);
  }
  if(up.requires && up.requires.length){
    up.requires.forEach(reqId=>{
      const name = UPGRADE_MAP[reqId]?.name ?? reqId;
      lines.push(name);
    });
  }
  return lines;
}

function getUpgradeBenefitLines(up){
  const lines = [];
  if(up.effect) lines.push(up.effect);
  return lines;
}

function updateUpgradeElement(el, up){
  const cost = up.cost ?? 0;
  const purchased = isUpgradePurchased(up.id);
  const affordable = pts >= cost;
  el.classList.toggle('purchased', purchased);
  el.classList.toggle('available', !purchased && affordable);
  el.classList.toggle('locked', !purchased && !affordable);
  el.disabled = purchased;

  const refs = el.__ui || {};
  const nameEl = refs.nameEl || el.querySelector('.upgrade-name');
  if(nameEl) nameEl.textContent = up.name;

  const detailsEl = refs.detailsEl || el.querySelector('.upgrade-details');
  if(detailsEl){
    const parts = [`Custo: ${fmtShort(cost)}`];
    const benefits = getUpgradeBenefitLines(up);
    if(benefits.length) parts.push(benefits.join(' • '));
    detailsEl.textContent = parts.join(' • ');
  }

  const statusEl = refs.statusEl || el.querySelector('.upgrade-status');
  if(statusEl){
    let statusText = '';
    if(purchased){
      statusText = 'Comprado';
    } else if(affordable){
      statusText = 'Pronto para comprar';
    }
    statusEl.textContent = statusText;
  }

  if(activeUpgradeTooltip && activeUpgradeTooltip.target === el){
    activeUpgradeTooltip.up = up;
    refreshUpgradeTooltip(up);
    positionUpgradeTooltip(el);
  }
}

function updateUpgradeAffordability(){
  upgradeElements.forEach((el, id)=>{
    const up = UPGRADE_MAP[id];
    if(up) updateUpgradeElement(el, up);
  });
}

function getUpgradeElement(id){
  if(upgradeElements.has(id)) return upgradeElements.get(id);
  const el = document.querySelector(`[data-upgrade="${id}"]`);
  if(el) upgradeElements.set(id, el);
  return el;
}

function tryBuyUpgrade(id){
  const up = UPGRADE_MAP[id];
  if(!up) return;
  if(isUpgradePurchased(id)) return;
  if(!canShowUpgrade(up)) return;
  const cost = up.cost ?? 0;
  if(pts < cost){
    const el = getUpgradeElement(id);
    if(el){
      el.classList.add('buzz');
      setTimeout(()=> el.classList.remove('buzz'), 320);
    }
    return;
  }

  pts -= cost;
  setUpgradePurchased(id, true);
  recalculateProduction();
  renderShop();
  renderUpgrades();
  evaluateAchievements();
  renderHUD();
  save(true);
}

function getBuildingMultiplier(buildingId){
  let bonus = 0;
  UPGRADE_DATA.forEach(up=>{
    if(!isUpgradePurchased(up.id)) return;
    if(up.bonus?.type === 'building' && up.bonus.target === buildingId){
      bonus += up.bonus.amount;
    }
  });
  return 1 + bonus;
}

function getFingerExtraPerDedo(){
  let extra = 0;
  UPGRADE_DATA.forEach(up=>{
    if(!isUpgradePurchased(up.id)) return;
    if(up.bonus?.type === 'finger'){
      extra += up.bonus.perDedo ?? 0;
    }
  });
  return extra;
}

function recalculateProduction(){
  let total = 0;
  SHOP.forEach(it=>{
    const owned = shopState[it.id]?.owned ?? 0;
    if(!owned) return;
    const multiplier = getBuildingMultiplier(it.id);
    total += owned * it.p * multiplier;
  });
  mps = total;
  const dedos = shopState.dedo?.owned ?? 0;
  const perDedo = getFingerExtraPerDedo();
  clickPow = 1 + (dedos * perDedo);
}

function renderUpgrades(){
  const grid = document.getElementById('upgradesGrid');
  if(!grid) return;
  hideUpgradeTooltip();
  grid.innerHTML = '';
  upgradeElements.clear();

  const fragment = document.createDocumentFragment();

  UPGRADE_DATA.forEach(up=>{
    const purchased = isUpgradePurchased(up.id);
    if(purchased) return;
    const visible = canShowUpgrade(up);
    if(!visible) return;

    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'upgrade-tile';
    item.classList.add('tooltip-host');
    item.dataset.upgrade = up.id;
    item.setAttribute('aria-label', up.name);

    const img = document.createElement('img');
    img.className = 'upgrade-img';
    img.src = up.img;
    img.alt = up.name;
    item.appendChild(img);

    const info = document.createElement('div');
    info.className = 'upgrade-info';
    info.hidden = true;

    const nameEl = document.createElement('strong');
    nameEl.className = 'upgrade-name';
    info.appendChild(nameEl);

    const detailsEl = document.createElement('div');
    detailsEl.className = 'upgrade-details';
    info.appendChild(detailsEl);

    const statusEl = document.createElement('div');
    statusEl.className = 'upgrade-status';
    info.appendChild(statusEl);

    item.appendChild(info);
    item.__ui = { nameEl, detailsEl, statusEl };

    const check = document.createElement('span');
    check.className = 'upgrade-check';
    check.textContent = '✔';
    item.appendChild(check);

    updateUpgradeElement(item, up);

    const handlePointerEnter = (ev)=> showUpgradeTooltip(item, up, ev);
    const handlePointerMove = (ev)=> positionUpgradeTooltip(item, ev);
    const handlePointerLeave = ()=> hideUpgradeTooltip();
    item.addEventListener('pointerenter', handlePointerEnter);
    item.addEventListener('pointermove', handlePointerMove);
    item.addEventListener('pointerleave', handlePointerLeave);
    item.addEventListener('focus', ()=> showUpgradeTooltip(item, up));
    item.addEventListener('blur', hideUpgradeTooltip);

    if(!purchased){
      item.addEventListener('click', ()=>{
        hideUpgradeTooltip();
        tryBuyUpgrade(up.id);
      });
    }

    fragment.appendChild(item);
    upgradeElements.set(up.id, item);
  });

  grid.appendChild(fragment);
  updateUpgradeAffordability();
  renderOwnedUpgradesCollection();
}

/* Atualiza apenas as classes de acessibilidade (can/cant) sem re-renderizar linhas */
function updateAffordability(){
  SHOP.forEach(it=>{
    const st   = shopState[it.id];
    const row  = document.querySelector(`tr[data-buy="${it.id}"]`);
    if(!row) return;

    const priceSingle = precoProximo(it.base, it.r, st.owned);
    const underLimit = st.owned < it.limit;
    const canPay = pts >= priceSingle;
    const can = underLimit && canPay;

    const costEl = row.querySelector('.cost');
    if(costEl){
      costEl.classList.toggle('can', can);
      costEl.classList.toggle('cant', !can);
    }
    row.classList.toggle('afford', can);
  });

  updateUpgradeAffordability();
}

/* Tenta comprar item ao clicar na linha */
function tryBuy(id){
  const it = SHOP.find(x=>x.id===id); if(!it) return;
  const st = shopState[id];
  const remainingLimit = it.limit - st.owned;
  if(remainingLimit <= 0) return;

  const priceSingle = precoProximo(it.base, it.r, st.owned);
  // encontrar a linha atual no DOM (pode ter sido re-renderizada)
  const row = document.querySelector(`tr[data-buy="${id}"]`);

  if(pts < priceSingle){
    if(row){
      // feedback: buzz
      row.classList.add('buzz');
      const s = row.querySelector('.status');
      if(s) s.textContent = '';
      setTimeout(()=> row.classList.remove('buzz'), 320);
    }
    return;
  }

  // compra: subtrai custo e atualiza owned
  pts -= priceSingle;
  st.owned += 1;

  if(id === 'namorada' && st.owned === 1){
    triggerCollapseSequence();
  }

  recalculateProduction();

  // If reached limit, visually mark
  if(st.owned >= it.limit){
    if(row){
      row.classList.remove('clickable'); row.classList.add('max');
      const s = row.querySelector('.status'); if(s) s.textContent = 'MAX';
    }
  }

  // Ao comprar, possivelmente desbloqueia o próximo item — re-render da loja
  renderShop();
  renderUpgrades();
  evaluateAchievements();
  renderHUD();
  save(true);

  // aplica flash na nova linha renderizada
  const newRow = document.querySelector(`tr[data-buy="${id}"]`);
  if(newRow) {
    newRow.classList.add('flashG');
    setTimeout(()=> newRow.classList.remove('flashG'), 450);
  }
}

/* init */
setupSettingsModal();
load();
recalculateProduction();
renderShop();
renderUpgrades();
evaluateAchievements(true);
renderAchievementsPanel();
renderHUD();
if(shopState?.namorada?.owned > 0){
  triggerCollapseSequence(true);
}
if(migratedLegacyUpgrades) save();
loop();
startAutoSave();

/* clique na imagem = ganhar pontos */
function getClickGain(){
  return Math.max(1, Math.floor(clickPow));
}
el('click').onclick=()=>{
  pts+=getClickGain();
  totalClicks += 1;
  evaluateAchievements();
  renderHUD();
  save();
  showFront();
};

/* ações */
if(redeemCodeButtonEl){
  redeemCodeButtonEl.addEventListener('click', promptAndRedeemCode);
}
el('deleteSave').onclick=()=>deleteSave();
if(collapseOverlayEl){
  collapseOverlayEl.addEventListener('pointermove', handleCollapsePointerMove);
  collapseOverlayEl.addEventListener('pointerleave', handleCollapseButtonLeave);
}
if(collapseButtonEl){
  collapseButtonEl.addEventListener('mouseenter', handleCollapseButtonHover);
  collapseButtonEl.addEventListener('mouseleave', handleCollapseButtonLeave);
  collapseButtonEl.addEventListener('click', handleCollapseButtonClick);
}
</script>
